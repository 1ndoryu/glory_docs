---
title: Sistema de Formularios
description: Arquitectura completa del sistema de formularios AJAX en Glory Framework
sidebar:
  label: Sistema de Formularios
  order: 2
---

import { Tabs, TabItem } from '@astrojs/starlight/components';

# üèóÔ∏è Sistema de Formularios - Arquitectura Completa

El **Sistema de Formularios** de Glory Framework es una soluci√≥n integral para crear, procesar y gestionar formularios web de manera segura, escalable y mantenible. Combina componentes del lado cliente y servidor para proporcionar una experiencia de desarrollo fluida.

## üéØ Caracter√≠sticas Principales

- ‚úÖ **Generaci√≥n autom√°tica de HTML** - Sin escribir markup repetitivo
- ‚úÖ **Validaci√≥n dual** - Cliente y servidor con consistencia
- ‚úÖ **Env√≠o AJAX autom√°tico** - Sin recargas de p√°gina
- ‚úÖ **Manejo de archivos** - Subida nativa con validaci√≥n
- ‚úÖ **Sistema de handlers** - Procesamiento modular del servidor
- ‚úÖ **Seguridad integrada** - Sanitizaci√≥n y validaci√≥n autom√°tica
- ‚úÖ **Logging completo** - Trazabilidad de todas las operaciones
- ‚úÖ **Extensibilidad** - F√°cil creaci√≥n de formularios personalizados

## üèõÔ∏è Arquitectura del Sistema

### Componentes Principales

```mermaid
graph TD
    A[Usuario] --> B[Formulario HTML]
    B --> C[JavaScript - gloryForm.js]
    C --> D[AJAX - gloryAjax.js]
    D --> E[FormHandler PHP]
    E --> F[Handler Espec√≠fico]
    F --> G[Base de Datos]
    F --> H[Email/Servicios]
    E --> I[Respuesta JSON]
    I --> D
    D --> C
    C --> B
    B --> A

    style A fill:#e1f5fe
    style B fill:#f3e5f5
    style C fill:#fff3e0
    style D fill:#e8f5e8
    style E fill:#ffebee
    style F fill:#f3e5f5
    style G fill:#e0f2f1
```

### 1. **FormBuilder (Generador de HTML)**

**Ubicaci√≥n**: `Glory/src/Components/FormBuilder.php`

Genera autom√°ticamente el HTML de los formularios con:
- Campos de entrada validados
- Atributos de accesibilidad
- Estructura sem√°ntica
- Integraci√≥n con JavaScript

### 2. **gloryForm.js (Validaci√≥n Cliente)**

**Ubicaci√≥n**: `Glory/assets/js/genericAjax/gloryForm.js`

Maneja:
- Validaci√≥n del lado cliente
- Eventos de formulario
- Estados de carga
- Feedback visual

### 3. **gloryAjax.js (Comunicaci√≥n)**

**Ubicaci√≥n**: `Glory/assets/js/genericAjax/gloryAjax.js`

Proporciona:
- Env√≠o AJAX unificado
- Manejo de errores
- Estados de carga
- Transformaci√≥n de respuestas

### 4. **FormHandler (Router del Servidor)**

**Ubicaci√≥n**: `Glory/src/Handler/FormHandler.php`

Sistema de routing que:
- Encuentra el handler apropiado
- Gestiona el ciclo de vida
- Maneja errores
- Registra operaciones

### 5. **Handlers Espec√≠ficos**

**Ubicaci√≥n**: `App/Handlers/Form/` (personalizados) o `Glory/Handler/Form/` (incluidos)

Clases que procesan l√≥gica espec√≠fica:
- Validaci√≥n de negocio
- Interacci√≥n con BD
- Env√≠o de emails
- Integraci√≥n con APIs

## üîÑ Flujo Completo de un Formulario

### Diagrama de Secuencia

```mermaid
sequenceDiagram
    participant U as Usuario
    participant F as Formulario
    participant JS as gloryForm.js
    participant A as gloryAjax.js
    participant FH as FormHandler
    participant H as Handler Espec√≠fico
    participant DB as Base de Datos

    U->>F: Env√≠a formulario
    F->>JS: Evento submit
    JS->>JS: Validaci√≥n cliente
    JS->>A: Enviar datos AJAX
    A->>FH: Petici√≥n HTTP POST
    FH->>FH: Buscar handler por subAccion
    FH->>H: Instanciar y ejecutar
    H->>H: Validar y procesar
    H->>DB: Operaciones BD
    DB-->>H: Resultado
    H-->>FH: Respuesta
    FH-->>A: JSON response
    A-->>JS: Procesar respuesta
    JS-->>F: Actualizar UI
    F-->>U: Feedback al usuario
```

### Ejemplo Pr√°ctico Completo

<Tabs>
  <TabItem label="Formulario HTML (PHP)">
```php
<?php
use Glory\Components\FormBuilder;

// Crear formulario de contacto
$formulario = new FormBuilder('contacto');
$formulario->action('gloryFormHandler')
          ->method('POST')
          ->addHidden('subAccion', 'ProcesarContacto')
          ->addText('nombre', 'Nombre completo', ['required' => true])
          ->addEmail('email', 'Correo electr√≥nico', ['required' => true])
          ->addTextarea('mensaje', 'Mensaje', [
              'required' => true,
              'rows' => 4
          ])
          ->addButton('enviar', 'Enviar mensaje', [
              'type' => 'submit',
              'class' => 'btn btn-primary'
          ])
          ->render();
?>
```
  </TabItem>

  <TabItem label="JavaScript (Cliente)">
```javascript
document.addEventListener('DOMContentLoaded', function() {
    // gloryForm.js maneja autom√°ticamente la validaci√≥n y env√≠o
    // Pero podemos a√±adir comportamiento personalizado

    const form = document.getElementById('contacto');

    // Antes de enviar
    form.addEventListener('gloryForm:beforeSubmit', function(e) {
        console.log('Enviando formulario de contacto...');
        mostrarSpinner();
    });

    // √âxito
    form.addEventListener('gloryForm:success', function(e) {
        console.log('Mensaje enviado:', e.detail);
        ocultarSpinner();
        mostrarMensajeExito(e.detail.message);
        form.reset();
    });

    // Error
    form.addEventListener('gloryForm:error', function(e) {
        console.error('Error:', e.detail);
        ocultarSpinner();
        mostrarMensajeError(e.detail.message);
    });
});
```
  </TabItem>

  <TabItem label="Handler (Servidor)">
```php
<?php
namespace App\Handlers\Form;

use Glory\Handler\Form\FormHandlerInterface;

class ProcesarContactoHandler implements FormHandlerInterface
{
    public function procesar(array $postDatos, array $archivos): array
    {
        // 1. Validar datos
        $this->validarDatos($postDatos);

        // 2. Procesar contacto
        $resultado = $this->procesarContacto($postDatos);

        // 3. Logging
        GloryLogger::info('Contacto procesado', [
            'email' => $postDatos['email']
        ]);

        // 4. Respuesta
        return [
            'alert' => '¬°Mensaje enviado correctamente!',
            'contactId' => $resultado['id']
        ];
    }

    private function validarDatos(array $datos): void
    {
        $requeridos = ['nombre', 'email', 'mensaje'];

        foreach ($requeridos as $campo) {
            if (empty($datos[$campo])) {
                throw new \Exception("Campo {$campo} es obligatorio");
            }
        }

        if (!is_email($datos['email'])) {
            throw new \Exception('Email inv√°lido');
        }
    }

    private function procesarContacto(array $datos): array
    {
        // Enviar email
        $asunto = "Nuevo contacto: {$datos['nombre']}";
        $mensaje = "De: {$datos['nombre']} ({$datos['email']})\n\n{$datos['mensaje']}";

        wp_mail(
            get_option('admin_email'),
            $asunto,
            $mensaje
        );

        return ['id' => uniqid('contact_')];
    }
}
```
  </TabItem>
</Tabs>

## üé® Beneficios del Sistema

### Para Desarrolladores

- **Rapidez**: Formularios complejos en minutos
- **Consistencia**: Mismo patr√≥n para todos los formularios
- **Mantenibilidad**: C√≥digo organizado y reutilizable
- **Seguridad**: Validaci√≥n autom√°tica y sanitizaci√≥n
- **Debugging**: Logging completo y herramientas de desarrollo

### Para Usuarios

- **Experiencia fluida**: Sin recargas de p√°gina
- **Feedback inmediato**: Validaci√≥n en tiempo real
- **Accesibilidad**: Formularios semanticamente correctos
- **Responsive**: Dise√±o adaptativo autom√°tico

## üîß Configuraci√≥n y Activaci√≥n

### Activaci√≥n del Sistema

```php
// En functions.php o archivo de configuraci√≥n
OpcionManager::register('glory_componente_glory_form_activado', [
    'type' => 'checkbox',
    'label' => 'Activar sistema de formularios AJAX',
    'description' => 'Permite procesamiento de formularios v√≠a AJAX',
    'default' => true,
    'section' => 'glory_ajax'
]);

OpcionManager::register('glory_componente_glory_ajax_activado', [
    'type' => 'checkbox',
    'label' => 'Activar utilidad AJAX',
    'description' => 'Habilita gloryAjax.js para comunicaciones',
    'default' => true,
    'section' => 'glory_ajax'
]);
```

### Verificaci√≥n de Estado

```php
// Verificar que el sistema est√© activo
if (GloryFeatures::isActive('gloryForm', 'glory_componente_glory_form_activado')) {
    // Sistema de formularios disponible
}

if (GloryFeatures::isActive('gloryAjax', 'glory_componente_glory_ajax_activado')) {
    // Utilidad AJAX disponible
}
```

## üìã Tipos de Formularios Soportados

### Formularios B√°sicos

- **Contacto**: Formularios de contacto con validaci√≥n de email
- **Registro**: Creaci√≥n de cuentas de usuario
- **Login**: Autenticaci√≥n de usuarios
- **Newsletter**: Suscripci√≥n a boletines

### Formularios Avanzados

- **Creaci√≥n de contenido**: Posts, p√°ginas, CPTs
- **Edici√≥n masiva**: Operaciones en lote
- **Importaci√≥n/Exportaci√≥n**: Gesti√≥n de datos
- **Configuraci√≥n**: Opciones y preferencias

### Formularios con Archivos

- **Subida de im√°genes**: Galer√≠as y avatares
- **Documentos**: PDFs, documentos de oficina
- **Medios**: Audio, video, archivos multimedia

## üîí Seguridad Integrada

### Sanitizaci√≥n Autom√°tica

```php
// Los datos llegan autom√°ticamente sanitizados
public function procesar(array $postDatos, array $archivos): array
{
    // $postDatos['email'] ya est√° sanitizado con sanitize_email()
    // $postDatos['mensaje'] ya est√° sanitizado con sanitize_textarea_field()
    // $postDatos['titulo'] ya est√° sanitizado con sanitize_text_field()
}
```

### Validaci√≥n de Permisos

```php
public function procesar(array $postDatos, array $archivos): array
{
    // Verificar permisos autom√°ticamente
    if (!current_user_can('publish_posts')) {
        throw new \Exception('Permisos insuficientes');
    }

    // Verificar ownership si aplica
    $postId = $postDatos['postId'] ?? 0;
    if ($postId && get_post_field('post_author', $postId) != get_current_user_id()) {
        throw new \Exception('No eres el autor de esta publicaci√≥n');
    }
}
```

### Protecci√≥n CSRF

```php
// El sistema maneja nonces autom√°ticamente
$formulario->addHidden('nonce', wp_create_nonce('mi_form_nonce'));

// En el handler
if (!wp_verify_nonce($postDatos['nonce'], 'mi_form_nonce')) {
    throw new \Exception('Token de seguridad inv√°lido');
}
```

## üìä Monitoreo y Analytics

### Logging Autom√°tico

El sistema registra autom√°ticamente:
- Env√≠o de formularios
- Procesamiento exitoso
- Errores y excepciones
- Tiempos de respuesta
- Datos de usuario (opcional)

### M√©tricas Disponibles

```php
// Obtener estad√≠sticas de formularios
$estadisticas = GloryLogger::getFormStatistics([
    'handler' => 'ProcesarContacto',
    'fecha_desde' => '2024-01-01',
    'fecha_hasta' => '2024-12-31'
]);

// Resultado incluye:
// - total_envios
// - exitos
// - errores
// - tiempo_promedio_respuesta
// - tipos_error_mas_comunes
```

## üöÄ Casos de Uso Avanzados

### Formularios Multi-paso

```php
class FormularioMultipasoHandler implements FormHandlerInterface
{
    public function procesar(array $postDatos, array $archivos): array
    {
        $paso = intval($postDatos['paso'] ?? 1);
        $datosAcumulados = json_decode($postDatos['datos_acumulados'] ?? '{}', true);

        switch ($paso) {
            case 1:
                return $this->procesarPaso1($postDatos, $datosAcumulados);
            case 2:
                return $this->procesarPaso2($postDatos, $datosAcumulados);
            case 3:
                return $this->procesarPasoFinal($postDatos, $datosAcumulados);
        }
    }
}
```

### Formularios Condicionales

```php
// JavaScript para campos condicionales
document.addEventListener('change', function(e) {
    if (e.target.name === 'tipo_usuario') {
        const camposEmpresa = document.querySelectorAll('.campo-empresa');
        const esEmpresa = e.target.value === 'empresa';

        camposEmpresa.forEach(campo => {
            campo.style.display = esEmpresa ? 'block' : 'none';
            campo.querySelector('input').disabled = !esEmpresa;
        });
    }
});
```

### Integraci√≥n con APIs Externas

```php
class IntegracionAPIHandler implements FormHandlerInterface
{
    public function procesar(array $postDatos, array $archivos): array
    {
        // Procesar datos localmente primero
        $datosLocal = $this->procesarLocalmente($postDatos);

        // Enviar a API externa
        $respuestaAPI = $this->enviarAApiExterna($datosLocal);

        // Actualizar base de datos local
        $this->actualizarBDLocal($respuestaAPI);

        return [
            'alert' => 'Datos sincronizados correctamente',
            'api_response' => $respuestaAPI
        ];
    }
}
```

## üõ†Ô∏è Extensibilidad

### Crear Componentes Personalizados

```php
// Extender FormBuilder
class MiFormBuilder extends FormBuilder
{
    public function addMiCampoPersonalizado($nombre, $label, $opciones = [])
    {
        // L√≥gica para campo personalizado
        return $this;
    }
}
```

### Hooks y Filtros Disponibles

```php
// Antes de procesar formulario
add_filter('glory_form_before_process', function($datos, $handler) {
    // Modificar datos o validaciones adicionales
    return $datos;
}, 10, 2);

// Despu√©s de procesar exitosamente
add_action('glory_form_success', function($resultado, $handler, $datosOriginales) {
    // Acciones adicionales como env√≠o de emails, logging, etc.
}, 10, 3);

// En caso de error
add_action('glory_form_error', function($error, $handler, $datosOriginales) {
    // Manejo de errores personalizado
}, 10, 3);
```

## üìö Mejores Pr√°cticas

### Estructura de C√≥digo

```
App/
‚îú‚îÄ‚îÄ Handlers/
‚îÇ   ‚îî‚îÄ‚îÄ Form/
‚îÇ       ‚îú‚îÄ‚îÄ ContactoHandler.php
‚îÇ       ‚îú‚îÄ‚îÄ RegistroHandler.php
‚îÇ       ‚îî‚îÄ‚îÄ PedidoHandler.php
‚îî‚îÄ‚îÄ Templates/
    ‚îî‚îÄ‚îÄ forms/
        ‚îú‚îÄ‚îÄ contacto.php
        ‚îú‚îÄ‚îÄ registro.php
        ‚îî‚îÄ‚îÄ pedido.php
```

### Nomenclatura

- **Handlers**: `{Accion}Handler.php`
- **Formularios**: `form-{tipo}.php`
- **IDs**: `form-{tipo}-{instancia}`
- **Clases CSS**: `.form-{tipo}`, `.campo-{nombre}`

### Testing

```php
// Test b√°sico de handler
public function testProcesamientoContacto()
{
    $handler = new ContactoHandler();
    $datos = [
        'nombre' => 'Juan P√©rez',
        'email' => 'juan@example.com',
        'mensaje' => 'Mensaje de prueba'
    ];

    $resultado = $handler->procesar($datos, []);

    $this->assertArrayHasKey('alert', $resultado);
    $this->assertEquals('¬°Mensaje enviado correctamente!', $resultado['alert']);
}
```

## üîç Soluci√≥n de Problemas

### Problemas Comunes

**Formulario no se env√≠a:**
- Verificar que `gloryAjax.js` est√© cargado
- Comprobar configuraci√≥n de `action` y `subAccion`
- Revisar validaci√≥n del lado cliente

**Handler no encontrado:**
- Verificar nomenclatura: `{SubAccion}Handler`
- Comprobar namespace registrado
- Revisar ubicaci√≥n del archivo

**Errores de validaci√≥n:**
- Verificar reglas de validaci√≥n en handler
- Comprobar sanitizaci√≥n autom√°tica
- Revisar logs para detalles

### Herramientas de Debug

```php
// Modo debug para formularios
define('GLORY_FORM_DEBUG', true);

// Logging detallado
GloryLogger::setLevel('debug');
```

---

El Sistema de Formularios de Glory Framework proporciona una base s√≥lida para crear interfaces web interactivas y seguras. Su arquitectura modular permite desarrollar r√°pidamente funcionalidades complejas mientras mantiene el c√≥digo organizado y mantenible.
