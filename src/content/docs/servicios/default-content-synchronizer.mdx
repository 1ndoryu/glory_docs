---
title: DefaultContentSynchronizer
description: Servicio de sincronizaci√≥n autom√°tica de contenido por defecto con gesti√≥n inteligente de actualizaciones
---

import { Card, CardGrid } from '@astrojs/starlight/components';

## Descripci√≥n General

El `DefaultContentSynchronizer` es un servicio avanzado que gestiona la sincronizaci√≥n autom√°tica de contenido por defecto en WordPress. Permite mantener posts predefinidos actualizados, detectar ediciones manuales y reparar autom√°ticamente la integridad de medios.

## Funcionalidades Principales

### üîÑ Sincronizaci√≥n Inteligente
- **Sincronizaci√≥n autom√°tica**: Actualiza contenido por defecto cuando cambian las definiciones
- **Detecci√≥n de ediciones manuales**: Preserva cambios realizados por usuarios administradores
- **Modos de actualizaci√≥n**: Soporta modos 'none', 'smart' y 'force'

### üñºÔ∏è Reparaci√≥n de Medios
- **Integridad autom√°tica**: Verifica y repara im√°genes destacadas y galer√≠as faltantes
- **Fallbacks inteligentes**: Asigna im√°genes por defecto cuando faltan archivos originales
- **Sanitizaci√≥n de contenido**: Corrige URLs rotas en contenido y metadatos

### üóÇÔ∏è Gesti√≥n de T√©rminos
- **Sincronizaci√≥n de taxonom√≠as**: Gestiona autom√°ticamente t√©rminos asociados a posts

## Uso B√°sico

### Sincronizaci√≥n Completa

```php
use Glory\Services\DefaultContentSynchronizer;

// Sincronizar todo el contenido por defecto
$synchronizer = new DefaultContentSynchronizer();
$synchronizer->sincronizar();
```

### Restablecimiento Forzado

```php
// Restablecer todo el contenido a valores por defecto
$synchronizer->restablecer();
```

### Detecci√≥n de Ediciones Manuales

```php
// Hook para detectar cuando un usuario edita contenido manualmente
add_action('save_post', [$synchronizer, 'detectarEdicionManual'], 10, 3);
```

## Definici√≥n de Contenido

### Estructura de Definiciones

```php
// En tu archivo de configuraci√≥n (ej: config.php)
$GLOBALS['glory_default_content_definitions'] = [
    'post' => [
        'permitirEliminacion' => true,
        'modoActualizacion' => 'smart', // 'none', 'smart', 'force'
        'definicionesPost' => [
            [
                'slugDefault' => 'pagina-inicio',
                'titulo' => 'P√°gina de Inicio',
                'contenido' => 'Contenido de la p√°gina principal...',
                'estado' => 'publish',
                'extracto' => 'Descripci√≥n breve',
                'imagenDestacadaAsset' => 'glory::hero-image.jpg',
                'galeriaAssets' => ['colors::image1.jpg', 'colors::image2.jpg'],
                'metaEntrada' => [
                    '_wp_page_template' => 'template-home.php',
                    'meta_personalizado' => 'valor'
                ]
            ]
        ]
    ]
];
```

## Modos de Actualizaci√≥n

### Modo 'none'
```php
'modoActualizacion' => 'none'
// No actualiza contenido existente, solo crea posts nuevos
```

### Modo 'smart'
```php
'modoActualizacion' => 'smart'
// Actualiza solo si el contenido no ha sido editado manualmente
```

### Modo 'force'
```php
'modoActualizacion' => 'force'
// Fuerza actualizaci√≥n de todo el contenido, incluso si fue editado
```

## Gesti√≥n de Medios

### Reparaci√≥n Autom√°tica

El servicio incluye `MediaIntegrityService` que autom√°ticamente:

- Verifica existencia de archivos de imagen destacada
- Reasigna im√°genes faltantes usando assets existentes
- Genera galer√≠as por defecto cuando no est√°n definidas
- Corrige URLs rotas en contenido y metadatos

### Fallbacks Determin√≠sticos

```php
// Los fallbacks se asignan de forma determin√≠stica basada en el ID del post
// para mantener consistencia entre sincronizaciones
private function chooseFallbackAssetForPost(int $postId): string
{
    // L√≥gica que selecciona imagen por defecto consistentemente
}
```

## Integraci√≥n con Hooks

### Hook de Sincronizaci√≥n

```php
// Sincronizaci√≥n autom√°tica al activar/desactivar plugins
register_activation_hook(__FILE__, function() {
    $sync = new DefaultContentSynchronizer();
    $sync->sincronizar();
});

// Sincronizaci√≥n peri√≥dica (opcional)
add_action('wp_loaded', function() {
    // Sincronizaci√≥n condicional seg√∫n necesidades
});
```

### Detecci√≥n de Ediciones

```php
// Hook para marcar posts editados manualmente
add_action('save_post', function($postId, $post, $isUpdate) {
    $sync = new DefaultContentSynchronizer();
    $sync->detectarEdicionManual($postId, $post, $isUpdate);
}, 10, 3);
```

## M√©todos de la API

### `sincronizar()`
Inicia proceso completo de sincronizaci√≥n de contenido por defecto.

### `restablecer()`
Restablece todo el contenido a valores por defecto, forzando actualizaci√≥n.

### `detectarEdicionManual(int $postId, WP_Post $post, bool $isUpdate)`
Detecta cuando un usuario administrador edita contenido manualmente.

## Consideraciones de Rendimiento

- **Procesamiento por lotes**: Maneja posts en lotes para evitar timeouts
- **Prevenci√≥n de bucles**: Evita procesamiento recursivo con flags internos
- **Logging condicional**: Solo registra informaci√≥n detallada en desarrollo

## Estados y Metadatos

### Metadatos de Control
- `_glory_default_content_slug`: Slug de la definici√≥n original
- `_glory_default_content_edited`: Marca si fue editado manualmente
- `_glory_content_mode`: Modo actual del contenido ('editor' o 'sync')

## Ejemplos Pr√°cticos

### P√°gina de Empresa

```php
[
    'slugDefault' => 'empresa',
    'titulo' => 'Sobre Nuestra Empresa',
    'contenido' => 'Contenido detallado sobre la empresa...',
    'imagenDestacadaAsset' => 'glory::empresa-hero.jpg',
    'metaEntrada' => [
        '_wp_page_template' => 'template-empresa.php',
        'empresa_telefono' => '+1-234-567-8900'
    ]
]
```

### Art√≠culo de Blog

```php
[
    'slugDefault' => 'primer-post-blog',
    'titulo' => 'Bienvenido a Nuestro Blog',
    'contenido' => 'Contenido del primer post...',
    'estado' => 'publish',
    'extracto' => 'Introducci√≥n a nuestra serie de art√≠culos',
    'metaEntrada' => [
        'blog_categoria' => 'noticias,anuncios'
    ]
]
```

## Troubleshooting

### Contenido No Se Actualiza
- Verificar que el modo de actualizaci√≥n no sea 'none'
- Comprobar si el post fue marcado como editado manualmente
- Revisar logs para errores de permisos

### Im√°genes No Aparecen
- Verificar que los assets existan en las carpetas del tema
- Comprobar permisos de escritura en uploads/
- Revisar configuraci√≥n de `MediaIntegrityService`

### Rendimiento Lento
- Considerar procesamiento por lotes m√°s peque√±os
- Implementar sincronizaci√≥n programada en lugar de en cada carga
- Optimizar consultas a base de datos
