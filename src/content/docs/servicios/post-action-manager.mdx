---
title: PostActionManager
description: Utilidades completas para operaciones CRUD de posts en WordPress con validaci贸n y logging
---

import { Card, CardGrid } from '@astrojs/starlight/components';

## Descripci贸n General

El `PostActionManager` proporciona una interfaz unificada y segura para realizar operaciones CRUD (Crear, Leer, Actualizar, Eliminar) en posts de WordPress. Incluye validaci贸n autom谩tica, manejo de errores, logging detallado y integraci贸n con el sistema de eventos.

## Funcionalidades Principales

### 锔 Operaciones CRUD Completas
- **Creaci贸n de posts**: Con validaci贸n de tipos y datos
- **Actualizaci贸n inteligente**: Preserva datos existentes, actualiza solo campos necesarios
- **Eliminaci贸n segura**: Con verificaci贸n de permisos y estados
- **Movimiento a papelera**: Operaciones reversibles

###  Validaci贸n y Seguridad
- **Validaci贸n de tipos**: Verifica existencia de post types
- **Control de permisos**: Solo usuarios autorizados pueden modificar
- **Sanitizaci贸n autom谩tica**: Limpieza de datos de entrada
- **Prevenci贸n de conflictos**: Estados de procesamiento seguros

###  Consultas Avanzadas
- **B煤squeda por ID**: Recuperaci贸n eficiente por identificador
- **B煤squeda por slug**: Localizaci贸n por URL amigable
- **Verificaci贸n de existencia**: M茅todos m煤ltiples de validaci贸n

## Uso B谩sico

### Creaci贸n de Posts

```php
use Glory\Services\PostActionManager;

// Crear un post simple
$postId = PostActionManager::crearPost('post', [
    'post_title' => 'Mi Nuevo Art铆culo',
    'post_content' => 'Contenido del art铆culo...',
    'post_status' => 'publish'
]);

// Crear una p谩gina con metadatos
$pageId = PostActionManager::crearPost('page', [
    'post_title' => 'P谩gina de Contacto',
    'post_content' => 'Informaci贸n de contacto...',
    'meta_input' => [
        '_wp_page_template' => 'template-contacto.php',
        'contacto_email' => 'info@empresa.com'
    ]
]);
```

### Actualizaci贸n de Posts

```php
// Actualizar contenido existente
$resultado = PostActionManager::updatePost([
    'ID' => 123,
    'post_title' => 'T铆tulo Actualizado',
    'post_content' => 'Nuevo contenido...'
]);

// Actualizar metadatos
$resultado = PostActionManager::updatePost([
    'ID' => 123,
    'meta_input' => [
        'precio' => 99.99,
        'disponible' => true
    ]
]);
```

### Eliminaci贸n de Posts

```php
// Mover a papelera (reversible)
$exito = PostActionManager::trashPost(123);

// Eliminaci贸n permanente
$exito = PostActionManager::deletePost(123, true); // true = force delete

// Eliminaci贸n normal (va a papelera)
$exito = PostActionManager::deletePost(123);
```

### Recuperaci贸n de Datos

```php
// Obtener post por ID
$post = PostActionManager::getPostById(123);

// Obtener post por slug
$post = PostActionManager::getPostBySlug('mi-articulo', 'post');

// Verificar existencia
$existe = PostActionManager::postExiste(123); // por ID
$existe = PostActionManager::postExiste('mi-slug', 'post', 'slug'); // por slug
```

## Gesti贸n de Estados

### Estados de Post V谩lidos

```php
// Estados permitidos para diferentes operaciones
$estadosValidos = [
    'publish',    // Publicado
    'draft',      // Borrador
    'pending',    // Pendiente de revisi贸n
    'private',    // Privado
    'trash',      // En papelera
    'future',     // Programado
    'auto-draft'  // Auto-guardado
];
```

### Validaci贸n de Estados

```php
// Para operaciones de eliminaci贸n
PostActionManager::deletePost($postId); // Solo posts publicados, borradores, etc.

// Para restaurar de papelera
PostActionManager::untrashPost($postId); // Solo posts en estado 'trash'
```

## Sistema de Eventos

### Eventos Autom谩ticos

El manager emite eventos autom谩ticamente a trav茅s de `EventBus`:

```php
// Evento emitido al actualizar post
EventBus::emit('post_' . $postType);

// Ejemplo: actualizar un post de tipo 'producto'
PostActionManager::updatePost(['ID' => 123, 'post_title' => 'Nuevo T铆tulo']);
// Emite: 'post_producto'
```

### Manejo de Eventos

```php
// Escuchar eventos de posts
EventBus::on('post_producto', function($data) {
    // L贸gica personalizada cuando se actualiza un producto
    error_log('Producto actualizado: ' . $data['post_id']);
});
```

## Validaci贸n y Manejo de Errores

### Tipos de Error Comunes

```php
// Errores manejados autom谩ticamente
$erroresPosibles = [
    'invalid_post_type'    => 'Tipo de post no v谩lido o inexistente',
    'missing_title'        => 'T铆tulo del post requerido',
    'missing_id'           => 'ID del post requerido para actualizaci贸n',
    'post_not_found'       => 'Post no encontrado',
    'insufficient_permissions' => 'Permisos insuficientes'
];
```

### Manejo de Errores

```php
// Con retorno de WP_Error
$resultado = PostActionManager::crearPost('invalid_type', $datos, true);
if (is_wp_error($resultado)) {
    $codigo = $resultado->get_error_code();
    $mensaje = $resultado->get_error_message();
    // Manejar error apropiadamente
}

// Con retorno de ID/0 (por defecto)
$resultado = PostActionManager::crearPost('post', $datos);
if ($resultado === 0) {
    // Error ocurrido, revisar logs
}
```

## Logging y Depuraci贸n

### Niveles de Logging

```php
// Logging autom谩tico para todas las operaciones
GloryLogger::error("PostActionManager::crearPost() - Invalid post type", [
    'tipoPost' => $tipoPost,
    'datos' => $datos
]);

GloryLogger::info("Post creado exitosamente", [
    'postId' => $postId,
    'tipoPost' => $tipoPost
]);
```

### Informaci贸n Registrada

Cada operaci贸n registra:
- Par谩metros de entrada
- Resultados de ejecuci贸n
- C贸digos y mensajes de error
- Informaci贸n de contexto del usuario

## Ejemplos Avanzados

### Creaci贸n de Contenido Complejo

```php
function crearProducto($datosProducto) {
    return PostActionManager::crearPost('producto', [
        'post_title' => $datosProducto['nombre'],
        'post_content' => $datosProducto['descripcion'],
        'post_status' => 'publish',
        'post_excerpt' => $datosProducto['resumen'],
        'meta_input' => [
            'precio' => $datosProducto['precio'],
            'sku' => $datosProducto['sku'],
            'stock' => $datosProducto['stock'],
            'categoria' => $datosProducto['categoria'],
            '_wp_page_template' => 'single-producto.php'
        ]
    ]);
}
```

### Sistema de Moderaci贸n

```php
function moderarContenido($postId, $accion) {
    switch ($accion) {
        case 'aprobar':
            return PostActionManager::updatePost([
                'ID' => $postId,
                'post_status' => 'publish'
            ]);

        case 'rechazar':
            return PostActionManager::trashPost($postId);

        case 'borrador':
            return PostActionManager::updatePost([
                'ID' => $postId,
                'post_status' => 'draft'
            ]);
    }
}
```

### Limpieza Autom谩tica

```php
function limpiarPostsAntiguos($dias = 30) {
    $postsAntiguos = get_posts([
        'date_query' => [
            'before' => $dias . ' days ago'
        ],
        'post_status' => 'trash',
        'posts_per_page' => -1
    ]);

    foreach ($postsAntiguos as $post) {
        PostActionManager::deletePost($post->ID, true); // Eliminaci贸n permanente
    }
}
```

## API de M茅todos

### `crearPost(string $tipoPost, array $datos, bool $retornarWpError = false): int|WP_Error`
Crea un nuevo post con validaci贸n completa.

### `updatePost(array $datos, bool $retornarWpError = false): int|WP_Error`
Actualiza un post existente.

### `deletePost(int $postId, bool $forzarBorrado = false): bool`
Elimina un post (a papelera o permanentemente).

### `trashPost(int $postId): bool`
Mueve un post a la papelera.

### `untrashPost(int $postId): bool`
Restaura un post desde la papelera.

### `getPostById(int $postId, string $formatoSalida = OBJECT): WP_Post|array|null`
Recupera un post por su ID.

### `getPostBySlug(string $slug, string $tipoPost, string $formatoSalida = OBJECT): WP_Post|array|null`
Recupera un post por su slug.

### `postExiste(int|string $identificador, string $tipoPost = 'post', string $campo = 'id'): bool`
Verifica si un post existe.

## Consideraciones de Seguridad

### Permisos Requeridos
- `edit_post` para actualizaci贸n
- `delete_post` para eliminaci贸n
- Validaci贸n de capacidades de usuario

### Sanitizaci贸n Autom谩tica
- Limpieza de datos de entrada
- Validaci贸n de tipos de datos
- Prevenci贸n de inyecci贸n de c贸digo

## Integraci贸n con Otros Servicios

### Con DefaultContentSynchronizer

```php
// Los servicios funcionan juntos
$sync = new DefaultContentSynchronizer();
$sync->sincronizar(); // Usa PostActionManager internamente

// Operaciones directas tambi茅n disponibles
PostActionManager::updatePost($datos);
```

### Con FormHandler

```php
// Procesamiento de formularios
$formHandler = new FormHandler();
$resultado = $formHandler->procesar($_POST);

// Si el formulario crea/edita posts
if ($resultado['exito']) {
    PostActionManager::updatePost([
        'ID' => $resultado['post_id'],
        'meta_input' => $resultado['datos_limpios']
    ]);
}
```

## Rendimiento y Optimizaci贸n

### Consultas Eficientes
- Uso de funciones nativas de WordPress optimizadas
- Cach茅 autom谩tico de WordPress
- Consultas indexadas

### Manejo de Memoria
- Procesamiento por lotes para operaciones masivas
- Liberaci贸n de objetos despu茅s del uso
- Prevenci贸n de memory leaks

## Troubleshooting

### Post No Se Crea
```php
// Verificar tipo de post existe
if (!post_type_exists($tipoPost)) {
    // Error: tipo de post no registrado
}

// Verificar t铆tulo presente
if (empty($datos['post_title'])) {
    // Error: t铆tulo requerido
}
```

### Actualizaci贸n Falla
```php
// Verificar post existe
if (!PostActionManager::postExiste($postId)) {
    // Error: post no encontrado
}

// Verificar permisos
if (!current_user_can('edit_post', $postId)) {
    // Error: permisos insuficientes
}
```

### Eventos No Se Disparan
```php
// Verificar EventBus est谩 disponible
if (!class_exists('Glory\\Services\\EventBus')) {
    // Error: EventBus no cargado
}
```










