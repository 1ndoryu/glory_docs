---
title: AssetManager
description: Registro y gestión de scripts y estilos en Glory
---

`AssetManager` unifica la gestión de scripts (JS) y estilos (CSS) para el framework y los temas.
Permite definir assets individuales o auto-descubrir carpetas enteras, manejar dependencias,
localizar datos de PHP a JavaScript y gestionar versionado para evitar problemas de caché.

En esta documentación se explica tanto la API pública (`define`, `defineFolder`, `register`) como
las decisiones de resolución de rutas y comportamiento recomendado al definir assets desde un tema.

## Principales métodos y opciones

- `define($type, $handle, $ruta, $config)` — Registrar un asset individual.
  - `$type`: `'script'` o `'style'`.
  - `$handle`: identificador del asset.
  - `$ruta`: ruta relativa al tema/framework (p. ej. `/assets/js/mi-script.js`).
  - `$config`: array con opciones (ver abajo).

- `defineFolder($type, $carpeta, $config, $prefijoHandle = '', $exclusiones = [])` — Auto-descubre archivos en una carpeta y registra handles con un prefijo. El parámetro `$exclusiones` permite excluir archivos específicos.
- `setGlobalDevMode(bool $activado)` — Establece el modo desarrollo globalmente para todos los assets.
- `isGlobalDevMode()` — Retorna si el modo desarrollo global está activado.

### Opciones comunes en `$config`

- `deps`: array de handles de los que depende el asset (p. ej. `['jquery']`).
- `in_footer`: (bool) encolar el script en el footer. Por defecto en scripts se usa `true` cuando corresponde.
- `localize`: array con `nombreObjeto` y `datos` para pasar variables de PHP a JS (similar a `wp_localize_script`).
- `area`: `'frontend'|'admin'|'both'` para controlar dónde se encola el asset.
- `defer`: (bool) si se añade el atributo `defer` al script (true por defecto en muchos casos).
- `dev_mode`: si es `true`, evita usar versiones cacheadas y carga la versión de desarrollo.
- `ver`: string para forzar versionado si es necesario.

- `feature`: string o array — indica que el asset depende de una *feature* controlada por `GloryFeatures`.
  - Si se pasa una `string` (ej. `'gloryAjax'`), AssetManager verificará `GloryFeatures::isActive('gloryAjax')` y
    omitirá el asset si la feature está desactivada.
  - Si se pasa un `array`, puede incluir `name` y `option` para mapear una `optionKey` distinta:
    `['name' => 'gloryAjax', 'option' => 'mi_opcion_ajax']`.
  - Compatibilidad: también se soporta la llave antigua `feature_option` junto con `feature`.

Nota: gracias a esta opción puedes simplificar la definición de assets sin envolver tu código con condicionales
`if (GloryFeatures::isActive(...))` — basta con declarar `'feature' => 'miFeature'` en la configuración del asset.

Nota: no todos los keys son obligatorios; AssetManager ignora keys desconocidas, lo que permite
extensiones futuras sin romper configuraciones existentes.

### Buenas prácticas

- Define assets del framework dentro de `Glory/` y assets específicos del tema en `App/Config/assets.php`.
- Usa `defineFolder` para evitar listar manualmente muchos archivos y permitir búsqueda automática de `.min.js/.min.css` en producción.
- Localiza únicamente los datos necesarios: `nonce`, `ajaxUrl`, `idUsuario`, etc.

- **Prefijos en handles**: cuando uses `defineFolder` en un tema, proporciona un `prefijoHandle` para evitar colisiones
  entre handles de distintos paquetes o plugins (ej. `tema-`).
- **Dónde definir assets**: define assets específicos del proyecto en `App/Config/assets.php`. El framework (`Glory/`)
  solo debe incluir assets reutilizables y agnósticos.

### Ejemplo: registrar un script con localize

```php
use Glory\Manager\AssetManager;

AssetManager::define(
    'script',
    'mi-script-personalizado',
    '/assets/js/mi-script.js',
    [
        'deps'      => ['jquery'],
        'in_footer' => true,
        'localize'  => [
            'nombreObjeto' => 'misDatos',
            'datos'        => [
                'idUsuario' => get_current_user_id(),
                'nonce'     => wp_create_nonce('mi_nonce_seguridad'),
            ],
        ]
    ]
);
```

### Ejemplo: definir una carpeta completa de estilos

```php
use Glory\Manager\AssetManager;

AssetManager::defineFolder(
    'style',
    '/assets/css/',
    ['deps' => [], 'media' => 'all'],
    'tema-', // Prefijo para los handles
    ['admin.css', 'debug.css'] // Archivos a excluir
);
```

### Ejemplo: configurar modo desarrollo global

```php
use Glory\Manager\AssetManager;

// Activar modo desarrollo para todos los assets
AssetManager::setGlobalDevMode(true);

// Verificar si está en modo desarrollo
if (AssetManager::isGlobalDevMode()) {
    // Lógica específica para desarrollo
}
```

### Cómo resuelve rutas y versiones

- Las rutas pasadas a `define`/`defineFolder` son relativas al directorio del tema o del framework según el contexto
  (internamente se usa la ruta del template con `get_template_directory()` o equivalente).
- Cuando no está en `dev_mode`, el manager buscará automáticamente versiones minificadas (`.min.js` / `.min.css`) y las
  usará si existen. Esto permite mantener versiones de desarrollo sin cambiar la configuración en producción.
- `ver` puede usarse para forzar una versión (cache-busting) cuando sea necesario.

### Comportamiento de `defineFolder`

- `defineFolder` explora la carpeta indicada y registra cada archivo como un asset separado usando el `prefijoHandle`.
- El parámetro `$exclusiones` permite excluir archivos específicos del descubrimiento automático.
- Fuera de `dev_mode` los resultados se cachean en archivos PHP serializados para mejorar rendimiento; dentro de `dev_mode` se fuerza la lectura directa para facilitar el desarrollo.
- El cache se invalida automáticamente cuando cambian los parámetros de configuración.

### Localize: formato y buenas prácticas

- El key `localize` debe incluir `nombreObjeto` y `datos`. AssetManager llama internamente a `wp_localize_script` o
  su equivalente, creando un objeto global en JavaScript accesible por los scripts dependientes.
- Evita exponer datos sensibles. Localiza solo identificadores, nonces y endpoints necesarios.

Ejemplo mínimo:

```php
'localize' => [
    'nombreObjeto' => 'gloryData',
    'datos' => [
        'ajaxUrl' => admin_url('admin-ajax.php'),
        'nonce' => wp_create_nonce('glory_nonce'),
    ],
]
```

### `area` y diferencias de encolado

- `area` controla dónde se encola el asset: `frontend`, `admin` o `both`. `AssetManager::register()` se encarga
  de enganchar los assets en los hooks adecuados (`wp_enqueue_scripts` y `admin_enqueue_scripts`).

### Atributos adicionales de script

- `defer` (bool) permite añadir el atributo `defer` al script para mejorar la carga. En general es recomendable
  usar `defer` para scripts que no necesitan ejecutarse antes del parseo del HTML.

### CSS Crítico

AssetManager incluye soporte integrado para CSS crítico, que permite servir estilos críticos inline en el `<head>` y cargar el resto de los estilos de forma asíncrona para mejorar el rendimiento.

- **Activación**: Se activa automáticamente cuando `GloryFeatures::isActive('cssCritico', 'glory_css_critico_activado')` retorna `true`.
- **Comportamiento**: Los estilos se cargan asíncronamente por defecto, pero se puede controlar con la opción `glory_css_critico_async_resto`.
- **Método `imprimirCssCritico()`**: Imprime el CSS crítico inline en el hook `wp_head`.

### URLs Externas y CDN

AssetManager soporta URLs absolutas para assets externos (CDN):

```php
AssetManager::define('script', 'jquery-cdn', 'https://code.jquery.com/jquery-3.6.0.min.js');
```

- Las URLs que comienzan con `http://` o `https://` (o `//` para protocol-relative) se tratan como externas.
- No se valida existencia en disco local para URLs externas.
- Se usa la versión especificada en `$config['ver']` o el valor por defecto del tema.

### Consideraciones finales y errores comunes

- No encole manualmente assets que ya estén definidos con AssetManager: usa los handles definidos para dependencias.
- Si necesitas forzar el registro/encolado manualmente, llama a `AssetManager::register()` antes de los hooks de enqueue
  o revisa la configuración de `Setup` del tema (normalmente ya lo hace por ti).
- Mantén los assets específicos del tema dentro de `App/Config/assets.php` y evita poner lógica de negocio dentro de los
  scripts del framework.

## Notas

- `AssetManager::register()` se encarga de enganchar los assets a `wp_enqueue_scripts` y `admin_enqueue_scripts` respetando la opción `area`.
- El sistema busca `.min.js`/`.min.css` cuando no está en `dev_mode` para servir los archivos optimizados.


