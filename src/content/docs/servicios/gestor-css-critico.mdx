---
title: GestorCssCritico
description: Servicio de gesti칩n autom치tica de CSS cr칤tico para optimizaci칩n de rendimiento web
sidebar:
  label: GestorCssCritico
  order: 7
---

import { Steps, Tabs, TabItem, Aside } from '@astrojs/starlight.components';

# GestorCssCritico

El **GestorCssCritico** es un servicio avanzado para la gesti칩n autom치tica de CSS cr칤tico en aplicaciones WordPress. Optimiza el rendimiento web al extraer y servir el CSS necesario para renderizar el contenido visible inicialmente (above the fold), reduciendo significativamente el tiempo de renderizado bloqueante.

## Filosof칤a

GestorCssCritico est치 dise침ado para ser:
- **Autom치tico**: Genera y sirve CSS cr칤tico sin intervenci칩n manual
- **Inteligente**: Cachea por URL y post, con fallbacks inteligentes
- **Escalable**: Maneja m칰ltiples p치ginas y tipos de contenido
- **No intrusivo**: Funciona con cualquier tema y configuraci칩n

## Caracter칤sticas Principales

- **Generaci칩n autom치tica**: Crea CSS cr칤tico en background cuando es necesario
- **Cache inteligente**: Almacena CSS por URL exacta o por post ID
- **Modos flexibles**: Soporte para generaci칩n local y remota
- **Admin UI**: Interfaz de administraci칩n para control manual
- **Invalidaci칩n autom치tica**: Limpia cache cuando se actualiza contenido
- **Navegaci칩n AJAX**: Se desactiva autom치ticamente en modo no-AJAX

## Arquitectura

### Componentes del Sistema

1. **GestorCssCritico**: Servicio principal de gesti칩n y orquestaci칩n
2. **LocalCriticalCss**: Generador local usando Node.js y Puppeteer
3. **API Remota**: Integraci칩n con servicios externos de generaci칩n
4. **Admin Interface**: Controles en la barra de administraci칩n
5. **Cache System**: Sistema de cache basado en WordPress transients

### Flujo de Funcionamiento

```mermaid
graph TD
    A[Usuario solicita p치gina] --> B{GestorCssCritico::getParaPaginaActual}
    B --> C{CSS en cache?}
    C -->|S칤| D[Servir CSS cacheado]
    C -->|No| E{Generaci칩n autom치tica habilitada?}
    E -->|S칤| F[Programar generaci칩n en background]
    E -->|No| G[Servir sin CSS cr칤tico]
    F --> H[WP-Cron genera CSS]
    H --> I[Almacenar en cache]
    I --> D
```

## Configuraci칩n Inicial

### Activaci칩n del Servicio

```php
use Glory\Services\GestorCssCritico;

// Inicializar el servicio (se hace autom치ticamente en Glory)
GestorCssCritico::init();
```

### Opciones de Configuraci칩n

Configura las opciones en el panel de administraci칩n del tema:

```php
// En functions.php o configuraci칩n del tema
OpcionManager::register('glory_css_critico_activado', [
    'type' => 'checkbox',
    'label' => 'Activar CSS Cr칤tico',
    'description' => 'Optimizar rendimiento con CSS cr칤tico',
    'default' => false,
    'section' => 'glory_performance'
]);

OpcionManager::register('glory_css_critico_auto', [
    'type' => 'checkbox',
    'label' => 'Generaci칩n Autom치tica',
    'description' => 'Generar CSS cr칤tico autom치ticamente en background',
    'default' => true,
    'section' => 'glory_performance'
]);

OpcionManager::register('glory_critical_css_mode', [
    'type' => 'select',
    'label' => 'Modo de Generaci칩n',
    'options' => [
        'local' => 'Local (Node.js)',
        'remote' => 'Remoto (API)'
    ],
    'default' => 'local',
    'section' => 'glory_performance'
]);
```

## Generaci칩n de CSS Cr칤tico

### Modo Local (Recomendado)

```php
// Configuraci칩n autom치tica - no requiere intervenci칩n
$config = [
    'url' => home_url('/'),
    'cssDir' => get_template_directory() . '/App/Assets/css',
    'timeout' => 60000,
    'renderWait' => 800,
    'skipLoadAfter' => 20000
];

// El servicio maneja todo autom치ticamente
$cssCritico = LocalCriticalCss::generate($url);
```

### Modo Remoto

```php
// Configurar endpoint remoto
OpcionManager::set('glory_critical_css_api_url', 'https://api.css-critical.com/generate');
OpcionManager::set('glory_critical_css_api_backup_url', 'https://backup.css-critical.com/generate');

// El servicio elige autom치ticamente el modo configurado
$cssCritico = GestorCssCritico::generarParaUrl($url);
```

## Uso Program치tico

### Obtener CSS para la P치gina Actual

```php
// En el header del tema (functions.php o header.php)
add_action('wp_head', function() {
    $cssCritico = GestorCssCritico::getParaPaginaActual();

    if ($cssCritico) {
        echo "<style id=\"glory-critical-css\">$cssCritico</style>\n";
    }
}, 5); // Ejecutar temprano, antes de otros estilos
```

### Generaci칩n Manual para URLs Espec칤ficas

```php
// Generar CSS cr칤tico para una URL espec칤fica
$url = home_url('/contacto/');
$css = GestorCssCritico::generarParaUrl($url);

if ($css) {
    // Almacenar para uso posterior
    GestorCssCritico::guardarCssParaUrl($url, $css);
    echo "CSS cr칤tico generado: " . strlen($css) . " bytes\n";
}
```

### Gesti칩n de Cache

```php
// Limpiar toda la cache de CSS cr칤tico
add_action('wp_ajax_glory_limpiar_css_critico', function() {
    if (!current_user_can('manage_options')) {
        wp_die('No autorizado');
    }

    global $wpdb;
    $prefijo = $wpdb->esc_like(GestorCssCritico::PREFIJO_CLAVE_CACHE);
    $sql = "DELETE FROM {$wpdb->options} WHERE option_name LIKE '_transient_{$prefijo}%'";

    $wpdb->query($sql);
    wp_send_json_success('Cache de CSS cr칤tico limpiado');
});

// Limpiar cache de un post espec칤fico
add_action('save_post', function($postId) {
    if (wp_is_post_revision($postId)) {
        return;
    }

    $claveCache = GestorCssCritico::PREFIJO_CLAVE_CACHE . $postId;
    delete_transient($claveCache);
});
```

## Interfaz de Administraci칩n

### Barra de Administraci칩n

El servicio agrega autom치ticamente controles a la barra de administraci칩n de WordPress:

```php
// Se registra autom치ticamente en init()
add_action('admin_bar_menu', [GestorCssCritico::class, 'registrarMenuAdminBar'], 100);
```

**Controles disponibles:**
- **CSS cr칤tico** (men칰 principal)
  - **Limpiar cach칠 CSS cr칤tico**: Elimina toda la cache almacenada
  - **Generar (esta p치gina)**: Crea CSS cr칤tico para la p치gina actual
  - **Generar para todas (background)**: Programa generaci칩n para todas las p치ginas

### Estado del Sistema

```php
// Ver estado de generaci칩n para todas las p치ginas
add_action('wp_ajax_glory_generar_css_critico_all', function() {
    if (!current_user_can('manage_options')) {
        wp_send_json_error('No autorizado');
    }

    // Obtener todas las p치ginas y posts publicados
    $urls = [home_url('/')];
    $query = new WP_Query([
        'post_type' => ['page', 'post'],
        'post_status' => 'publish',
        'posts_per_page' => 200,
        'fields' => 'ids'
    ]);

    foreach ($query->posts as $postId) {
        $urls[] = get_permalink($postId);
    }

    // Programar generaci칩n en background
    $when = time() + 5;
    foreach (array_unique($urls) as $url) {
        if (!wp_next_scheduled('glory_generate_critical_css_event', [$url])) {
            wp_schedule_single_event($when, 'glory_generate_critical_css_event', [$url]);
            $when += 2; // Espaciar ejecuciones
        }
    }

    wp_send_json_success('Generaci칩n programada para ' . count($urls) . ' URLs');
});
```

## Optimizaciones Avanzadas

### Fallbacks de Cache

```php
// El servicio implementa m칰ltiples estrategias de cache:
// 1. Cache exacto por URL
// 2. Cache sin par치metro noAjax
// 3. Cache por path sin query params
// 4. Cache de home can칩nica

private function getCssCacheado(string $url): ?string
{
    // 1. Intento exacto
    $css = get_transient($this->getClaveCacheParaUrl($url));
    if ($css) return $css;

    // 2. Sin par치metro noAjax
    if (isset($_GET['noAjax'])) {
        $urlSinNoAjax = remove_query_arg('noAjax', $url);
        $css = get_transient($this->getClaveCacheParaUrl($urlSinNoAjax));
        if ($css) return $css;
    }

    // 3. Path can칩nico
    $path = wp_parse_url($url, PHP_URL_PATH) ?: '/';
    $urlSinQuery = home_url($path);
    if ($urlSinQuery !== $url) {
        $css = get_transient($this->getClaveCacheParaUrl($urlSinQuery));
        if ($css) return $css;
    }

    // 4. Home si es p치gina de inicio
    if (is_front_page() || is_home()) {
        $home = home_url('/');
        $css = get_transient($this->getClaveCacheParaUrl($home));
        if ($css) return $css;
    }

    return null;
}
```

### Prevenci칩n de Sobrecarga

```php
// Locks para evitar generaci칩n simult치nea
private function getLockKey(string $url): string
{
    return self::PREFIJO_LOCK . md5($url);
}

// Solo una generaci칩n por URL cada 5 minutos
if (!get_transient($this->getLockKey($url))) {
    set_transient($this->getLockKey($url), 1, 5 * MINUTE_IN_SECONDS);
    wp_schedule_single_event(time() + 5, 'glory_generate_critical_css_event', [$url]);
}
```

### Modo no-AJAX

```php
// Inyectar bandera global para congelar navegaci칩n AJAX
add_action('wp_head', function() {
    if (is_admin()) return;

    $noAjax = isset($_GET['noAjax']) && $_GET['noAjax'] === '1';
    if (!$noAjax) return;

    ?>
    <script>
    (function(w){
        // Bandera global para cualquier script que necesite detectar modo congelado
        w.__GLORY_NO_AJAX__ = true;

        // Config de navegaci칩n AJAX de Glory: abortar e inhabilitar
        var cfg = w.gloryNavConfig || {};
        cfg.enabled = false;
        cfg.shouldAbortInit = function(){ return true; };
        cfg.shouldSkipAjax = function(){ return true; };
        w.gloryNavConfig = cfg;
    })(window);
    </script>
    <?php
}, 0);
```

## Casos de Uso

### Tema WordPress Optimizado

```php
// En functions.php
add_action('after_setup_theme', function() {
    // Inicializar servicio
    GestorCssCritico::init();

    // Inyectar CSS cr칤tico en el head
    add_action('wp_head', function() {
        $cssCritico = GestorCssCritico::getParaPaginaActual();

        if ($cssCritico) {
            echo "<style id=\"critical-css\">$cssCritico</style>\n";

            // Cargar CSS completo de forma as칤ncrona
            add_action('wp_footer', function() {
                echo "<link rel=\"preload\" href=\"" . get_stylesheet_uri() . "\" as=\"style\" onload=\"this.onload=null;this.rel='stylesheet'\">\n";
                echo "<noscript><link rel=\"stylesheet\" href=\"" . get_stylesheet_uri() . "\"></noscript>\n";
            });
        } else {
            // Fallback: cargar CSS normalmente
            wp_enqueue_style('theme-styles', get_stylesheet_uri());
        }
    }, 5);
});
```

### E-commerce con P치ginas Din치micas

```php
class CssCriticoEcommerce
{
    public static function init()
    {
        add_action('wp_head', [self::class, 'inyectarCssCritico'], 5);
        add_action('save_post', [self::class, 'limpiarCacheProducto'], 10, 1);
    }

    public static function inyectarCssCritico()
    {
        // Para productos, usar cache por post ID
        if (is_singular('product')) {
            global $post;
            $css = self::getCssParaProducto($post->ID);

            if ($css) {
                echo "<style id=\"critical-css-product\">$css</style>\n";
                return;
            }
        }

        // Para otras p치ginas, usar el sistema est치ndar
        $css = GestorCssCritico::getParaPaginaActual();
        if ($css) {
            echo "<style id=\"critical-css\">$css</style>\n";
        }
    }

    private static function getCssParaProducto(int $productId): ?string
    {
        $claveCache = GestorCssCritico::PREFIJO_CLAVE_CACHE . $productId;
        return get_transient($claveCache);
    }

    public static function limpiarCacheProducto(int $postId)
    {
        if (get_post_type($postId) !== 'product') {
            return;
        }

        $claveCache = GestorCssCritico::PREFIJO_CLAVE_CACHE . $postId;
        delete_transient($claveCache);
    }
}

// Inicializar
CssCriticoEcommerce::init();
```

### Integraci칩n con Page Builders

```php
// Para temas que usan page builders como Elementor o Avada
class CssCriticoPageBuilder
{
    public static function init()
    {
        // Detectar cambios en contenido de page builder
        add_action('save_post', [self::class, 'limpiarCachePageBuilder'], 10, 1);

        // Inyectar CSS cr칤tico con consideraciones especiales
        add_action('wp_head', [self::class, 'inyectarCssOptimizado'], 5);
    }

    public static function limpiarCachePageBuilder(int $postId)
    {
        // Limpiar cache cuando se edita con page builder
        if (isset($_POST['action']) && $_POST['action'] === 'elementor_ajax') {
            $claveCache = GestorCssCritico::PREFIJO_CLAVE_CACHE . $postId;
            delete_transient($claveCache);
        }
    }

    public static function inyectarCssOptimizado()
    {
        $cssCritico = GestorCssCritico::getParaPaginaActual();

        if ($cssCritico) {
            // Para page builders, agregar clase especial para evitar conflictos
            echo "<style id=\"critical-css\" class=\"glory-critical-css\">$cssCritico</style>\n";

            // Cargar CSS del page builder despu칠s
            add_action('wp_enqueue_scripts', function() {
                wp_enqueue_style('page-builder-styles');
            }, 100);
        }
    }
}
```

## Monitoreo y Debugging

### Logging Integrado

```php
// Todas las operaciones se registran autom치ticamente
// Ejemplos de logs generados:

// [GloryLogger] CssCritico: cache HIT por postId (postId: 123, bytes: 15432)
// [GloryLogger] CssCritico: cache MISS por URL exacta
// [GloryLogger] CssCritico: generaci칩n programada por WP-Cron (url: https://example.com/)
// [GloryLogger] CssCritico: cron guard칩 CSS cr칤tico (URL y postId) (url: https://example.com/, postId: 1, bytes: 15432)
```

### Verificaci칩n de Estado

```php
// Funci칩n de debugging para verificar estado
function debug_css_critico()
{
    if (!current_user_can('manage_options') || !WP_DEBUG) {
        return;
    }

    $currentUrl = home_url(add_query_arg([], $_SERVER['REQUEST_URI'] ?? '/'));
    $css = GestorCssCritico::getParaPaginaActual();

    echo "<!-- DEBUG CSS CR칈TICO\n";
    echo "URL: $currentUrl\n";
    echo "CSS encontrado: " . ($css ? 'S칈 (' . strlen($css) . ' bytes)' : 'NO') . "\n";

    // Verificar modos
    $modo = OpcionManager::get('glory_critical_css_mode') ?: 'local';
    echo "Modo: $modo\n";

    $activo = OpcionManager::get('glory_css_critico_activado');
    echo "Activo: " . ($activo ? 'S칈' : 'NO') . "\n";

    $auto = OpcionManager::get('glory_css_critico_auto');
    echo "Auto: " . ($auto ? 'S칈' : 'NO') . "\n";

    echo "-->\n";
}
add_action('wp_head', 'debug_css_critico', 1);
```

## Consideraciones de Rendimiento

### Impacto en Tiempos de Respuesta

- **Primera visita**: Sin CSS cr칤tico (hasta que se genere)
- **Visitas posteriores**: CSS cr칤tico servido instant치neamente desde cache
- **Generaci칩n**: Se hace en background, no afecta usuarios

### Optimizaciones de Cache

```php
// Configuraci칩n recomendada de expiraci칩n
const EXPIRACION_CACHE = DAY_IN_SECONDS; // 24 horas

// Locks para evitar sobrecarga
const TIEMPO_LOCK = 5 * MINUTE_IN_SECONDS; // 5 minutos entre generaciones
```

### Recursos del Sistema

**Requisitos para modo local:**
- Node.js instalado en el servidor
- Puppeteer para renderizado
- Espacio en disco para cache
- Permisos de ejecuci칩n para comandos del sistema

## Soluci칩n de Problemas

### CSS cr칤tico no se genera

**Posibles causas:**
- Servicio no activado en opciones
- Modo local sin Node.js configurado
- Errores en la generaci칩n (ver logs)

**Soluci칩n:**
```php
// Verificar configuraci칩n
$activo = OpcionManager::get('glory_css_critico_activado');
$modo = OpcionManager::get('glory_critical_css_mode');

if (!$activo) {
    // Activar el servicio
    OpcionManager::set('glory_css_critico_activado', true);
}

// Para modo local, verificar Node.js
if ($modo === 'local') {
    $nodePath = getenv('GLORY_CRITICAL_CSS_NODE') ?: 'node';
    exec($nodePath . ' --version', $output, $returnCode);

    if ($returnCode !== 0) {
        error_log('Node.js no encontrado para CSS cr칤tico');
    }
}
```

### CSS cr칤tico no se aplica

**Posibles causas:**
- CSS cr칤tico no inyectado en el `<head>`
- Conflicto con otros estilos
- CSS mal generado

**Verificaci칩n:**
```php
// Verificar inyecci칩n en wp_head
add_action('wp_head', function() {
    $css = GestorCssCritico::getParaPaginaActual();
    if ($css) {
        echo "<!-- CSS CR칈TICO ENCONTRADO: " . strlen($css) . " bytes -->\n";
    } else {
        echo "<!-- NO SE ENCONTR칍 CSS CR칈TICO -->\n";
    }
}, 1);
```

### Errores de AJAX en administraci칩n

**Problema:** Los controles de la barra de administraci칩n no funcionan
**Causa:** Problemas con AJAX de WordPress
**Soluci칩n:** Verificar que `admin-ajax.php` sea accesible y que no haya conflictos de JavaScript

### Cache no se limpia

**Problema:** CSS cr칤tico obsoleto despu칠s de cambios
**Causa:** Hooks de limpieza no funcionando
**Soluci칩n:**
```php
// Forzar limpieza manual
global $wpdb;
$prefijo = $wpdb->esc_like(GestorCssCritico::PREFIJO_CLAVE_CACHE);
$wpdb->query("DELETE FROM {$wpdb->options} WHERE option_name LIKE '_transient_{$prefijo}%'");
```

## Mejores Pr치cticas

### Configuraci칩n de Producci칩n

```php
// En producci칩n, configurar para estabilidad
OpcionManager::set('glory_css_critico_activado', true);
OpcionManager::set('glory_css_critico_auto', true);
OpcionManager::set('glory_critical_css_mode', 'remote'); // M치s estable que local
```

### Monitoreo Continuo

```php
// Agregar m칠tricas de rendimiento
add_action('wp_footer', function() {
    if (!current_user_can('manage_options') || !WP_DEBUG) {
        return;
    }

    $cssCritico = GestorCssCritico::getParaPaginaActual();
    $tiempoGeneracion = get_transient('glory_css_critico_tiempo_gen_' . md5($_SERVER['REQUEST_URI']));

    if ($cssCritico && $tiempoGeneracion) {
        echo "<!-- CSS Cr칤tico: " . strlen($cssCritico) . " bytes, generado en {$tiempoGeneracion}s -->\n";
    }
});
```

### Integraci칩n con CDN

```php
// Si usas CDN, considera estrategias especiales
add_filter('glory_css_critico_url_transform', function($url) {
    // Transformar URLs para que funcionen con CDN durante generaci칩n
    if (defined('CDN_DOMAIN')) {
        return str_replace(home_url(), CDN_DOMAIN, $url);
    }
    return $url;
});
```

<Aside type="caution">
丘멆잺 **Importante**: El CSS cr칤tico debe probarse exhaustivamente. Un CSS cr칤tico incorrecto puede romper el dise침o visual de la p치gina. Siempre verifica el resultado en diferentes dispositivos y navegadores.
</Aside>

<Aside type="tip">
游눠 **Tip**: Para mejores resultados, combina CSS cr칤tico con preload de recursos y lazy loading de im치genes. El CSS cr칤tico es solo una parte de una estrategia completa de optimizaci칩n web.
</Aside>
