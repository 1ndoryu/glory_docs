---
title: PageManager
description: "Gestión programática de páginas: definir, sincronizar y controlar plantillas/roles"
---
`PageManager` permite definir páginas desde código y mantenerlas sincronizadas con WordPress: crea/actualiza páginas, asigna plantillas, controla acceso por roles y, cuando usas handlers por función, delega el render en una plantilla central (`TemplateGlory.php`).

## Resumen

- Declara páginas por `slug` y handler (función o plantilla).
- Sincroniza con la BD (crear/actualizar) y limpia obsoletas.
- Controla acceso por roles, modo de contenido y SEO por defecto.

## Cuándo usarlo

- Cuando quieras asegurar que ciertas páginas del proyecto existan siempre con los ajustes correctos.
- Cuando prefieras una plantilla central con renderizado por función en vez de múltiples plantillas sueltas.
- Cuando necesites restringir páginas por roles o preconfigurar SEO por defecto.

## API básica

```php
<?php
use Glory\Manager\PageManager;

/**
 * Define una página gestionada por código.
 *
 * @param string      $slug       Slug (^[a-z0-9]+(?:-[a-z0-9]+)*$).
 * @param string|null $handler    Nombre de función de render o archivo .php de plantilla.
 *                                - Si termina en .php ⇒ se usa como plantilla.
 *                                - Si no termina en .php y no se provee $plantilla ⇒ usa TemplateGlory.php y la función.
 * @param string|null $plantilla  Nombre de plantilla cuando $handler es un título.
 * @param array       $roles      Roles requeridos para ver la página (obliga login y valida roles).
 */
PageManager::define(string $slug, ?string $handler = null, ?string $plantilla = null, array $roles = []): void;

/**
 * Intercepta la plantilla y enruta a TemplateGlory.php si corresponde.
 */
PageManager::register(): void;

/**
 * Crea/actualiza en BD todas las páginas definidas.
 * - Marca con _page_manager_managed.
 * - Sincroniza _wp_page_template.
 * - Ajusta modo de contenido por defecto y prellena editor si aplica.
 * - Si el slug es 'home' y la página es válida, la fija como página frontal.
 */
PageManager::procesarPaginasDefinidas(): void;

/**
 * Indica a TemplateGlory.php qué función ejecutar.
 * @return string|null
 */
PageManager::getFuncionParaRenderizar(): ?string;

/** Modo de contenido por defecto global: 'code' | 'editor'. */
PageManager::setDefaultContentMode(string $mode): void;
PageManager::getDefaultContentMode(): string;
```

### Parámetros complejos

- SEO map (`setDefaultSeoMap`): por cada `slug` puedes definir `title`, `desc`, `canonical`, `faq` (array) y `breadcrumb` (array). No sobreescribe valores ya presentes en meta.
- Modo de contenido: `'code'` (por defecto) o `'editor'`. En `'editor'` se prellena con el HTML del handler si el contenido no ha sido editado (hash coincide) o está vacío.
- Roles: si se indican, se fuerza login y se valida con `UserUtility::tieneRoles`. Si falla, redirige a login o 403.

## Ejemplo mínimo

```php
use Glory\Manager\PageManager;

// 1) Definir página 'home' renderizada por función
PageManager::define('home', 'home_render');

// 2) Interceptar plantilla y sincronizar definiciones
PageManager::register();
PageManager::procesarPaginasDefinidas();
```

## Ejemplo avanzado (roles, SEO, editor, reconciliar)

```php
use Glory\Manager\PageManager;

// Páginas
PageManager::define('contacto', 'Contacto', 'TemplateContacto.php');
PageManager::define('panel-privado', 'panel_privado_render', null, ['administrator']);

// Modo de contenido por defecto
PageManager::setDefaultContentMode('editor');

// SEO por defecto
PageManager::setDefaultSeoMap([
    'home' => [
    'title' => 'Inicio - Mi Sitio',
    'desc' => 'Bienvenido a mi sitio',
    'canonical' => home_url('/'),
    'faq' => [ ['q' => '¿Qué es?', 'a' => 'Es un sitio.'] ],
    'breadcrumb' => [ ['name' => 'Inicio', 'url' => home_url('/') ] ],
  ],
]);

// Registrar e instalar cambios
PageManager::register();
PageManager::procesarPaginasDefinidas();

// Tras eliminar definiciones del código, depurar obsoletas con seguridad
PageManager::reconciliarPaginasGestionadas();
```

## Recomendaciones

- Define páginas en `App/Config/pages.php` o en el bootstrap del tema para centralizar.
- Usa `TemplateGlory.php` cuando el handler sea función; debe invocar `PageManager::getFuncionParaRenderizar()` y ejecutar la función.
- Ejecuta `procesarPaginasDefinidas()` en activación/deploy; usa `reconciliarPaginasGestionadas()` al retirar definiciones.
- El slug `home` puede fijarse automáticamente como página frontal si la página es válida.

## Notas y edge cases

- Si falta `TemplateGlory.php` y defines handlers por función, se registrará un error y se usará la plantilla original.
- Slugs inválidos no se definen (se registra error y se ignoran).
- Migración a `editor`: solo cuando el contenido no ha sido editado (hash coincide) o está vacío.
- Reconciliación nunca elimina la página frontal ni la de entradas.

## Modo Dev/Local

- Configuración de entorno: `App/Config/environment.php` lee `.env` (`DEV` y `LOCAL`). `DEV=true` activa el modo desarrollo global vía `AssetManager::setGlobalDevMode(true)`.
- Sincronización automática en DEV:
  - Admin: se ejecuta una sincronización completa (opciones, páginas y contenido por defecto) al cargar el admin.
  - Frontend: sincronización ligera solo de páginas gestionadas: `procesarPaginasDefinidas()` y `reconciliarPaginasGestionadas()`.
  - Requiere que la feature `pageManager` esté activa en `GloryFeatures`.
- Producción (DEV=false): no hay sincronizaciones automáticas. Ejecuta sincronizaciones manuales (barra de admin «Glory Sync») o llama a `procesarPaginasDefinidas()` en tu flujo de deploy.
- Relación con modo editor: la sincronización en DEV respeta el hash; solo re‑prellena cuando el contenido no ha sido editado manualmente.

## Integración con el tema (App)

- Ubicación sugerida: `App/Config/pages.php`.
- Mantén los handlers de render en archivos de funciones del tema o en componentes reusables.
- Glory es agnóstico: no coloques lógica específica del proyecto en el núcleo.

## API avanzada

```php
<?php
use Glory\Manager\PageManager;

/**
 * Elimina páginas gestionadas que ya no están definidas (sin tocar página frontal/entradas).
 */
PageManager::reconciliarPaginasGestionadas(): void;

/**
 * SEO por defecto por slug. Claves soportadas:
 * - title (string)
 * - desc (string)
 * - canonical (string, se normaliza con barra final)
 * - faq (array, se guarda JSON)
 * - breadcrumb (array, se guarda JSON)
 */
PageManager::setDefaultSeoMap(array $map): void;
PageManager::getDefaultSeoForSlug(string $slug): array;

/** Consultas auxiliares */
PageManager::getModoContenidoParaPagina(int $postId): string; // 'code' | 'editor'
PageManager::getHandlerPorSlug(string $slug): ?string;         // nombre de función o null
PageManager::getDefinicionPorSlug(string $slug): ?array;       // ['titulo','plantilla','funcion','slug','roles']

/** Devuelve el HTML del handler para prellenar editor/sync inteligente. */
PageManager::renderHandlerParaCopiar(string $handler): string;
```

## Errores frecuentes

- Slug con mayúsculas o caracteres inválidos.
- Olvidar `register()` y la función no se ejecuta vía `TemplateGlory.php`.
- Asignar roles inexistentes o esperar acceso en admin sin ajustar capacidades.
- Cambiar plantillas y no re‑sincronizar (`procesarPaginasDefinidas`).
- Esperar que sobreescriba SEO existente: solo completa si no hay valores.

---
