---
title: Sistema de Previsualizaciones
description: Gesti√≥n interactiva de archivos con drag & drop, selecci√≥n por clic y previsualizaci√≥n en tiempo real
---

import { Card, CardGrid } from '@astrojs/starlight/components';

# Sistema de Previsualizaciones (`gestionarPreviews.js`)

Sistema avanzado para la gesti√≥n interactiva de archivos que proporciona previsualizaci√≥n en tiempo real, soporte para drag & drop y selecci√≥n por clic.

## üöÄ Inicio R√°pido

```html
<!-- Estructura HTML b√°sica -->
<div class="previewContenedor">
    <input type="file" name="mi_archivo" style="display: none;">
    <div class="previewImagen oculto">
        <span class="image-preview-placeholder">Haz clic para subir una imagen</span>
    </div>
    <button type="button" class="botonPreviewImagen">Seleccionar Imagen</button>
</div>
```

```javascript
// El sistema se inicializa autom√°ticamente en gloryRecarga
// No requiere configuraci√≥n manual adicional
```

## üìã Funcionalidades

### Tipos de Archivo Soportados
- **Im√°genes** (`.previewImagen`, `.preview`): JPG, PNG, GIF, WebP, SVG
- **Audio** (`.previewAudio`): MP3, WAV, OGG, M4A
- **Archivos gen√©ricos** (`.previewFile`): Cualquier tipo de archivo

### M√©todos de Interacci√≥n
- **Clic en botones**: `.botonPreviewImagen`, `.botonPreviewAudio`, `.botonPreviewFile`
- **Clic en √°reas de preview**: Zonas interactivas que abren el selector
- **Drag & Drop**: Arrastrar archivos directamente sobre las zonas
- **Contenedor completo**: `data-uploadclick="true"` para clics en cualquier parte

## üé® Estructura HTML Requerida

### Contenedor Principal
```html
<div class="previewContenedor">
    <!-- Input oculto -->
    <input type="file" name="archivo" accept="image/*" style="display: none;">

    <!-- √Årea de preview para im√°genes -->
    <div class="previewImagen oculto">
        <span class="image-preview-placeholder">Haz clic para subir una imagen</span>
    </div>

    <!-- Bot√≥n disparador -->
    <button type="button" class="botonPreviewImagen">Seleccionar Imagen</button>
</div>
```

### Variantes por Tipo de Archivo

#### Para Im√°genes
```html
<div class="previewContenedor">
    <input type="file" name="imagen" accept="image/*" style="display: none;">
    <div class="previewImagen oculto">
        <span class="image-preview-placeholder">Arrastra o haz clic para subir imagen</span>
    </div>
    <button class="botonPreviewImagen">Seleccionar Imagen</button>
</div>
```

#### Para Audio
```html
<div class="previewContenedor">
    <input type="file" name="audio" accept="audio/*" style="display: none;">
    <div class="previewAudio oculto"></div>
    <button class="botonPreviewAudio">Seleccionar Audio</button>
</div>
```

#### Para Archivos Gen√©ricos
```html
<div class="previewContenedor">
    <input type="file" name="documento" style="display: none;">
    <div class="previewFile oculto"></div>
    <button class="botonPreviewFile">Seleccionar Archivo</button>
</div>
```

## üîß Atributos de Configuraci√≥n

### data-uploadclick
Permite que cualquier clic en el contenedor abra el selector de archivos.

```html
<div class="previewContenedor" data-uploadclick="true">
    <!-- Contenido del contenedor -->
</div>
```

### data-preview-id y data-preview-for
Vincula manualmente inputs y previews cuando no est√°n en la misma jerarqu√≠a.

```html
<!-- Input en un lugar -->
<input type="file" data-preview-for="mi-preview">

<!-- Preview en otro lugar -->
<div data-preview-id="mi-preview" class="previewImagen oculto"></div>
```

### data-extrapreview
Muestra elementos adicionales durante operaciones de drag & drop o clic.

```html
<div class="previewContenedor" data-extrapreview=".elemento-extra">
    <div class="elemento-extra oculto">Suelta el archivo aqu√≠</div>
    <!-- Contenido normal -->
</div>
```

### data-extrapreview-on
Controla cu√°ndo mostrar el preview extra: `"click"`, `"drag"`, `"drop"`, `"always"`.

```html
<div class="previewContenedor"
     data-extrapreview=".zona-drop"
     data-extrapreview-on="drag">
    <!-- Contenido -->
</div>
```

### data-activapreview
Permite activar un contenedor oculto desde elementos externos durante drag.

```html
<!-- Elemento externo que activa preview -->
<div data-activapreview=".mi-contenedor-oculto">Zona de drop externa</div>

<!-- Contenedor que se activa -->
<div class="previewContenedor mi-contenedor-oculto oculto">
    <!-- Contenido -->
</div>
```

## üìù API T√©cnica

### Funciones Principales

#### `gestionarPreviews()`
Inicializa todo el sistema de previsualizaciones.

```javascript
// Se ejecuta autom√°ticamente en gloryRecarga
// Puede llamarse manualmente si es necesario
gestionarPreviews();
```

#### `mostrarImagenDesdeUrl(imageUrl, elementoPreview, imageId)`
Muestra una imagen desde una URL (√∫til para im√°genes existentes).

```javascript
const previewElement = document.querySelector('.previewImagen');
mostrarImagenDesdeUrl('https://example.com/image.jpg', previewElement, 123);
```

### Eventos Personalizados

#### `gloryImageUploader:showExistingImage`
Muestra una imagen existente en un uploader.

```javascript
document.dispatchEvent(new CustomEvent('gloryImageUploader:showExistingImage', {
    detail: {
        imageUrl: 'https://example.com/image.jpg',
        imageId: 123,
        uploaderContainer: document.querySelector('.previewContenedor')
    }
}));
```

## üéØ Estados Visuales

### Clases CSS Autom√°ticas
- `.oculto`: Elementos inicialmente ocultos
- `.arrastrando`: Durante operaciones de drag & drop
- `.activo`: Elementos extra mostrados
- `.previewRemover`: Bot√≥n de eliminar imagen (se crea autom√°ticamente)

### Campos Ocultos Autom√°ticos
El sistema gestiona autom√°ticamente campos hidden para WordPress:
- `.glory-image-id`: ID de la imagen en WordPress
- `.glory-image-url`: URL de la imagen
- `input[name$="_delete"]`: Indicador de eliminaci√≥n

## üîÑ Flujo de Funcionamiento

### 1. Inicializaci√≥n
- Se vinculan todos los event listeners
- Se previene duplicaci√≥n en recargas (`gloryRecarga`)

### 2. Interacci√≥n del Usuario
- **Clic**: Abre selector de archivos con filtros apropiados
- **Drag**: Muestra indicadores visuales y activa zonas de drop
- **Drop**: Procesa el archivo soltado

### 3. Procesamiento
- Valida tipo de archivo
- Muestra preview apropiada
- Actualiza campos ocultos
- Gestiona estados visuales

### 4. Eliminaci√≥n
- Bot√≥n X autom√°tico para im√°genes
- Restaura placeholders
- Limpia campos ocultos

## üé® Personalizaci√≥n CSS

### Clases Principales
```css
.previewContenedor { /* Contenedor principal */ }
.previewImagen { /* √Årea de preview de imagen */ }
.previewAudio { /* √Årea de preview de audio */ }
.previewFile { /* √Årea de preview de archivo */ }
.botonPreviewImagen { /* Bot√≥n disparador */ }
.arrastrando { /* Estado durante drag */ }
.oculto { /* Elementos ocultos */ }
.activo { /* Elementos extra activos */ }
```

### Estilos de Drag & Drop
```css
.previewContenedor.arrastrando {
    border: 2px dashed #007cba;
    background-color: rgba(0, 124, 186, 0.1);
}
```

## üîß Integraci√≥n con WordPress

### Campos Esperados
```php
// El sistema espera estos campos para integraci√≥n completa
<input type="hidden" name="image_id" class="glory-image-id">
<input type="hidden" name="image_url" class="glory-image-url">
<input type="hidden" name="image_delete" value="">
```

### Eventos de Integraci√≥n
```javascript
// Para mostrar im√°genes existentes
document.dispatchEvent(new CustomEvent('gloryImageUploader:showExistingImage', {
    detail: { imageUrl, imageId, uploaderContainer }
}));
```

## üêõ Soluci√≥n de Problemas

### Problemas Comunes

1. **Preview no aparece**: Verificar estructura HTML correcta y clases
2. **Drag & drop no funciona**: Revisar que no haya elementos superpuestos
3. **Filtros de archivo ignorados**: Verificar atributo `accept` en input
4. **Im√°genes no se eliminan**: Revisar campos hidden y placeholders

### Debug
```javascript
// Habilitar logs detallados
window.gloryDebug = true;

// Verificar inicializaci√≥n
console.log('Previews handlers bound:', window.__gloryPreviewsHandlersBound);
```

## üìä Rendimiento

- **Lazy Loading**: Los handlers se vinculan solo una vez
- **Prevenci√≥n de Duplicados**: Sistema de flags para evitar listeners m√∫ltiples
- **Optimizaci√≥n**: FileReader solo para archivos v√°lidos
- **Memory Management**: Limpieza autom√°tica de elementos y listeners

## üîÑ Compatibilidad

- ‚úÖ **Modern Browsers**: ES6+, File API, Drag & Drop API
- ‚úÖ **Mobile**: Touch events y responsive design
- ‚úÖ **WordPress**: Integraci√≥n completa con media library
- ‚úÖ **Accesibilidad**: Soporte b√°sico para navegaci√≥n por teclado
- ‚úÖ **Progressive Enhancement**: Funciona sin JavaScript habilitado (solo input b√°sico)





