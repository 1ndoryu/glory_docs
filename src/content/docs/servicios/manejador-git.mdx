---
title: ManejadorGit
description: Servicio para gesti√≥n completa de repositorios Git con operaciones avanzadas
sidebar:
  label: ManejadorGit
  order: 6
---

import { Steps, Tabs, TabItem, Aside } from '@astrojs/starlight/components';

# ManejadorGit

El **ManejadorGit** es un servicio avanzado para gesti√≥n completa de repositorios Git en PHP. Proporciona una interfaz segura y robusta para ejecutar comandos Git, gestionar repositorios remotos, hacer commits, push y operaciones de sincronizaci√≥n. Est√° dise√±ado espec√≠ficamente para entornos WordPress donde la seguridad y el manejo de errores son cr√≠ticos.

## Filosof√≠a

ManejadorGit est√° dise√±ado para ser:
- **Seguro**: Ejecuta comandos con validaci√≥n estricta y manejo de errores
- **Robusto**: Maneja diferentes sistemas operativos (Windows/Linux)
- **Completo**: Soporta todas las operaciones Git comunes
- **Logged**: Registra todas las operaciones para debugging

## Caracter√≠sticas Principales

- **Ejecuci√≥n multiplataforma**: Soporte nativo para Windows y Linux/Unix
- **Gesti√≥n de remotos**: Configuraci√≥n autom√°tica de URLs de remotos
- **Operaciones completas**: Clone, fetch, checkout, commit, push, reset
- **Manejo de ramas**: Creaci√≥n y cambio entre ramas de trabajo
- **Sincronizaci√≥n segura**: Operaciones at√≥micas con rollback
- **Logging integrado**: Todas las operaciones se registran con GloryLogger

## Inicializaci√≥n

### Uso B√°sico

```php
use Glory\Services\ManejadorGit;

$manejador = new ManejadorGit();

// Verificar estado de un repositorio
$estado = $manejador->obtenerArchivosModificados('/ruta/al/repo');
```

### Configuraci√≥n por Defecto

El servicio no requiere configuraci√≥n inicial espec√≠fica. Todas las operaciones se ejecutan con par√°metros seguros por defecto.

## Operaciones B√°sicas

### Verificar Estado del Repositorio

```php
// Obtener archivos modificados
$archivosModificados = $manejador->obtenerArchivosModificados('/path/to/repo');

if (!empty($archivosModificados)) {
    echo "Archivos modificados:\n";
    foreach ($archivosModificados as $archivo) {
        echo "- $archivo\n";
    }
} else {
    echo "Repositorio limpio, no hay cambios.\n";
}
```

### Configurar URL de Remoto

```php
$repoUrl = 'https://github.com/usuario/proyecto.git';
$rutaLocal = '/var/www/html/proyecto';

// Configurar o actualizar remote 'origin'
$exito = $manejador->establecerUrlRemota('origin', $repoUrl, $rutaLocal);

if ($exito) {
    echo "Remote 'origin' configurado correctamente.\n";
} else {
    echo "Error al configurar el remote.\n";
}
```

### Clonar o Actualizar Repositorio

```php
$repoUrl = 'https://github.com/usuario/proyecto.git';
$rutaLocal = '/var/www/html/proyecto';
$ramaTrabajo = 'main'; // o 'master' para repos antiguos

// Clonar si no existe, o actualizar si existe
$exito = $manejador->clonarOActualizarRepo($repoUrl, $rutaLocal, $ramaTrabajo);

if ($exito) {
    echo "Repositorio listo en: $rutaLocal\n";
} else {
    echo "Error al gestionar el repositorio.\n";
}
```

## Operaciones Avanzadas

### Hacer Commit de Cambios

```php
$rutaRepo = '/var/www/html/proyecto';
$mensaje = 'feat: agregar nueva funcionalidad

- Implementar feature X
- Corregir bug Y
- Actualizar documentaci√≥n';

$exito = $manejador->hacerCommit($rutaRepo, $mensaje);

if ($exito) {
    echo "Commit realizado correctamente.\n";
} else {
    echo "Error al hacer commit o no hay cambios para commitear.\n";
}
```

### Push a Remoto

```php
$rutaRepo = '/var/www/html/proyecto';
$rama = 'main';
$establecerUpstream = true; // Configurar tracking autom√°tico

$exito = $manejador->hacerPush($rutaRepo, $rama, $establecerUpstream);

if ($exito) {
    echo "Push realizado correctamente a rama '$rama'.\n";
} else {
    echo "Error al hacer push.\n";
}
```

### Descartar Cambios Locales

```php
// ‚ö†Ô∏è ATENCI√ìN: Esto eliminar√° todos los cambios locales no commiteados
$rutaRepo = '/var/www/html/proyecto';

$exito = $manejador->descartarCambiosLocales($rutaRepo);

if ($exito) {
    echo "Cambios locales descartados. Repositorio en estado limpio.\n";
} else {
    echo "Error al descartar cambios locales.\n";
}
```

## Flujo de Trabajo Completo

### Sincronizaci√≥n de Proyecto

```php
class SincronizadorProyecto
{
    private ManejadorGit $git;

    public function __construct()
    {
        $this->git = new ManejadorGit();
    }

    public function sincronizarDesdeRemoto(string $repoUrl, string $rutaLocal): bool
    {
        // Paso 1: Clonar o actualizar repositorio
        if (!$this->git->clonarOActualizarRepo($repoUrl, $rutaLocal, 'main')) {
            return false;
        }

        // Paso 2: Verificar si hay cambios locales
        $cambios = $this->git->obtenerArchivosModificados($rutaLocal);

        if (!empty($cambios)) {
            echo "Hay cambios locales pendientes. ¬øQu√© deseas hacer?\n";
            echo "Cambios encontrados:\n";
            foreach ($cambios as $cambio) {
                echo "- $cambio\n";
            }
            return false; // No continuar autom√°ticamente
        }

        echo "Repositorio sincronizado correctamente.\n";
        return true;
    }

    public function publicarCambios(string $rutaLocal, string $mensaje): bool
    {
        // Paso 1: Hacer commit
        if (!$this->git->hacerCommit($rutaLocal, $mensaje)) {
            echo "No hay cambios para commitear.\n";
            return true; // No es error, simplemente no hay cambios
        }

        // Paso 2: Hacer push
        if (!$this->git->hacerPush($rutaLocal, 'main')) {
            return false;
        }

        echo "Cambios publicados correctamente.\n";
        return true;
    }
}

// Uso
$sincronizador = new SincronizadorProyecto();

// Sincronizar proyecto
$sincronizador->sincronizarDesdeRemoto(
    'https://github.com/miuser/miproyecto.git',
    '/var/www/html/miproyecto'
);

// Publicar cambios
$sincronizador->publicarCambios(
    '/var/www/html/miproyecto',
    'feat: implementar nueva funcionalidad'
);
```

## Gesti√≥n de Ramas

### Cambiar a Rama Espec√≠fica

```php
class GestorRamas
{
    private ManejadorGit $git;

    public function __construct()
    {
        $this->git = new ManejadorGit();
    }

    public function cambiarARama(string $rutaRepo, string $nombreRama): bool
    {
        // El m√©todo clonarOActualizarRepo ya maneja el cambio de ramas
        // Pero podemos crear un m√©todo espec√≠fico si necesitamos m√°s control

        $ramaActual = $this->obtenerRamaActual($rutaRepo);

        if ($ramaActual === $nombreRama) {
            echo "Ya est√°s en la rama '$nombreRama'.\n";
            return true;
        }

        // Usar checkout directo
        $resultado = $this->ejecutarComandoGit(['checkout', $nombreRama], $rutaRepo);

        if ($resultado['exito']) {
            echo "Cambiado a rama '$nombreRama'.\n";
            return true;
        } else {
            echo "Error al cambiar a rama '$nombreRama': " . $resultado['error'] . "\n";
            return false;
        }
    }

    private function obtenerRamaActual(string $rutaRepo): ?string
    {
        $resultado = $this->ejecutarComandoGit(['branch', '--show-current'], $rutaRepo);
        return $resultado['exito'] ? trim($resultado['salida']) : null;
    }

    private function ejecutarComandoGit(array $comando, string $rutaRepo): array
    {
        // Nota: Este es un ejemplo simplificado.
        // En la implementaci√≥n real, usar√≠as los m√©todos del ManejadorGit
        return ['exito' => false, 'salida' => '', 'error' => 'Implementaci√≥n pendiente'];
    }
}
```

## Manejo de Errores y Logging

### Sistema de Logging Integrado

Todas las operaciones del ManejadorGit se registran autom√°ticamente:

```php
// Los logs aparecen en debug.log cuando WP_DEBUG est√° activo
// Ejemplo de logs generados:

// [INFO] Intentando ejecutar comando: git status --porcelain
// [INFO] Comando 'git status --porcelain' ejecutado (c√≥digo 0)
// [ERROR] Comando 'git push origin main' fall√≥ con c√≥digo 128. Error: Repository not found
```

### Manejo de Errores Robusto

```php
try {
    $exito = $manejador->clonarOActualizarRepo($repoUrl, $rutaLocal, 'main');

    if (!$exito) {
        // El error ya fue logged por el ManejadorGit
        // Tomar acci√≥n correctiva
        $this->notificarAdministrador('Error de sincronizaci√≥n Git');
        return false;
    }

} catch (ExcepcionComandoFallido $e) {
    // Error grave que impidi√≥ la ejecuci√≥n
    error_log('Error cr√≠tico en Git: ' . $e->getMessage());
    $this->notificarAdministrador('Error cr√≠tico de Git: ' . $e->getMessage());
}
```

## Consideraciones de Seguridad

### Validaci√≥n de Rutas

```php
// ‚úÖ Validar rutas antes de usar
function validarRutaGit(string $ruta): bool
{
    // Verificar que la ruta existe
    if (!is_dir($ruta)) {
        return false;
    }

    // Verificar que es un repositorio Git
    if (!is_dir($ruta . '/.git')) {
        return false;
    }

    // Verificar permisos de escritura
    if (!is_writable($ruta)) {
        return false;
    }

    return true;
}

// ‚ùå No usar rutas sin validar
$manejador->hacerCommit($_POST['ruta']); // PELIGROSO
```

### Sanitizaci√≥n de Entradas

```php
// ‚úÖ Sanitizar mensajes de commit
function sanitizarMensajeCommit(string $mensaje): string
{
    // Remover caracteres de control
    $mensaje = filter_var($mensaje, FILTER_SANITIZE_STRING, FILTER_FLAG_NO_ENCODE_QUOTES);

    // Limitar longitud
    if (strlen($mensaje) > 5000) {
        $mensaje = substr($mensaje, 0, 5000) . '...';
    }

    return $mensaje;
}

// ‚úÖ Sanitizar URLs de repositorio
function sanitizarUrlRepo(string $url): string
{
    // Solo permitir protocolos seguros
    if (!preg_match('/^https?:\/\//', $url)) {
        throw new Exception('Solo se permiten URLs HTTP/HTTPS');
    }

    // Validar formato b√°sico de URL
    if (!filter_var($url, FILTER_VALIDATE_URL)) {
        throw new Exception('URL inv√°lida');
    }

    return $url;
}
```

## Casos de Uso Avanzados

### Sistema de Despliegue Autom√°tico

```php
class DesplegadorAutomatico
{
    private ManejadorGit $git;

    public function __construct()
    {
        $this->git = new ManejadorGit();
    }

    public function desplegarVersion(string $version): bool
    {
        $repoUrl = 'https://github.com/empresa/proyecto.git';
        $rutaDespliegue = '/var/www/html/proyecto-live';

        // Paso 1: Sincronizar con rama espec√≠fica
        if (!$this->git->clonarOActualizarRepo($repoUrl, $rutaDespliegue, 'main')) {
            return false;
        }

        // Paso 2: Checkout a tag espec√≠fico
        $tag = "v$version";
        $resultado = $this->ejecutarGit(['checkout', $tag], $rutaDespliegue);

        if (!$resultado['exito']) {
            // Si el tag no existe, intentar con commit hash
            if (!$this->ejecutarGit(['checkout', $version], $rutaDespliegue)['exito']) {
                error_log("Tag o commit '$version' no encontrado");
                return false;
            }
        }

        // Paso 3: Ejecutar tareas de post-despliegue
        $this->postDespliegue($rutaDespliegue);

        return true;
    }

    private function postDespliegue(string $ruta): void
    {
        // Instalar dependencias, migrar BD, limpiar cache, etc.
        // ... l√≥gica espec√≠fica del proyecto
    }
}
```

### Backup Autom√°tico con Git

```php
class BackupGit
{
    private ManejadorGit $git;

    public function __construct()
    {
        $this->git = new ManejadorGit();
    }

    public function crearBackup(string $rutaProyecto, string $rutaBackup): bool
    {
        $timestamp = date('Y-m-d_H-i-s');
        $mensaje = "Backup autom√°tico - $timestamp";

        // Crear copia del repositorio
        if (!$this->git->clonarOActualizarRepo($rutaProyecto, $rutaBackup, 'main')) {
            return false;
        }

        // Hacer commit de cualquier cambio pendiente
        $this->git->hacerCommit($rutaBackup, $mensaje);

        // Crear tag para este backup
        $tag = "backup-$timestamp";
        $this->ejecutarGit(['tag', $tag], $rutaBackup);

        return true;
    }

    public function listarBackups(string $rutaBackup): array
    {
        $resultado = $this->ejecutarGit(['tag', '--list', 'backup-*'], $rutaBackup);

        if (!$resultado['exito']) {
            return [];
        }

        return array_filter(explode("\n", trim($resultado['salida'])));
    }
}
```

## Soluci√≥n de Problemas

### Error: "Repository not found"

**Causa:** URL del repositorio incorrecta o sin permisos
**Soluci√≥n:**
```php
// Verificar URL
$urlActual = $manejador->obtenerUrlRemota('origin', $rutaRepo);
echo "URL actual: $urlActual\n";

// Corregir URL si es necesario
$nuevaUrl = 'https://github.com/correcto/proyecto.git';
$manejador->establecerUrlRemota('origin', $nuevaUrl, $rutaRepo);
```

### Error: "Permission denied"

**Causa:** Problemas de autenticaci√≥n SSH o HTTPS
**Soluci√≥n:**
```php
// Para HTTPS: verificar credenciales
// Para SSH: verificar clave SSH configurada

// Verificar conexi√≥n
$resultado = $manejador->ejecutarComando(['git', 'ls-remote', $repoUrl], $rutaRepo, false);

if (!$resultado['exito']) {
    echo "Error de conexi√≥n: " . $resultado['error'] . "\n";

    // Posibles soluciones:
    // 1. Configurar credenciales HTTPS
    // 2. Configurar clave SSH
    // 3. Verificar permisos del repositorio
}
```

### Error: "Already up-to-date"

**Significado:** No hay cambios nuevos para actualizar
**Soluci√≥n:** Es un mensaje informativo, no un error. El repositorio ya est√° sincronizado.

### Repositorio en estado "detached HEAD"

**Causa:** HEAD apunta a un commit espec√≠fico en lugar de una rama
**Soluci√≥n:**
```php
// Verificar estado
$resultado = $manejador->ejecutarComando(['git', 'branch'], $rutaRepo, false);

// Si estamos en detached HEAD, hacer checkout a una rama
$manejador->ejecutarComando(['git', 'checkout', 'main'], $rutaRepo, false);
```

## API de Referencia

### M√©todos P√∫blicos

#### `obtenerUrlRemota(string $nombreRemoto, string $rutaRepo): ?string`
Obtiene la URL configurada para un remoto espec√≠fico.

#### `establecerUrlRemota(string $nombreRemoto, string $nuevaUrl, string $rutaRepo): bool`
Configura o actualiza la URL de un remoto.

#### `clonarOActualizarRepo(string $repoUrl, string $rutaLocal, string $ramaTrabajo): bool`
Clona un repositorio si no existe, o lo actualiza si existe.

#### `hacerCommit(string $rutaRepo, string $mensaje): bool`
Hace commit de todos los cambios en el repositorio.

#### `hacerPush(string $rutaRepo, string $rama, bool $establecerUpstream = false): bool`
Hace push de una rama espec√≠fica al remoto.

#### `descartarCambiosLocales(string $rutaRepo): bool`
Descarta todos los cambios locales no commiteados.

#### `obtenerArchivosModificados(string $rutaRepo): ?array`
Retorna la lista de archivos modificados en el repositorio.

## Mejores Pr√°cticas

### Manejo Seguro de Credenciales

```php
// ‚úÖ Usar variables de entorno para tokens
$repoUrl = getenv('GIT_REPO_URL') ?: 'https://github.com/default/repo.git';

// ‚úÖ No hardcodear credenciales
// ‚ùå $repoUrl = 'https://user:password@github.com/repo.git';
// ‚úÖ Usar SSH o tokens de acceso
```

### Validaci√≥n Exhaustiva

```php
function validarOperacionGit(string $rutaRepo, string $operacion): bool
{
    // Verificar que existe el directorio
    if (!is_dir($rutaRepo)) {
        throw new Exception("Directorio no existe: $rutaRepo");
    }

    // Verificar que es un repositorio Git
    if (!is_dir($rutaRepo . '/.git')) {
        throw new Exception("No es un repositorio Git: $rutaRepo");
    }

    // Verificar permisos
    if (!is_readable($rutaRepo) || !is_writable($rutaRepo)) {
        throw new Exception("Permisos insuficientes en: $rutaRepo");
    }

    // Operaciones espec√≠ficas requieren permisos adicionales
    if ($operacion === 'push' && !is_executable($rutaRepo . '/.git')) {
        throw new Exception("No se puede hacer push: permisos insuficientes");
    }

    return true;
}
```

### Logging y Monitoreo

```php
class GitMonitor
{
    public static function logOperacion(string $operacion, string $rutaRepo, bool $exito, string $detalles = ''): void
    {
        $mensaje = sprintf(
            '[GitMonitor] %s | Repo: %s | Exito: %s | %s',
            $operacion,
            basename($rutaRepo),
            $exito ? 'SI' : 'NO',
            $detalles
        );

        error_log($mensaje);

        // Notificar a administradores en caso de errores cr√≠ticos
        if (!$exito && self::esOperacionCritica($operacion)) {
            self::notificarAdministrador($mensaje);
        }
    }

    private static function esOperacionCritica(string $operacion): bool
    {
        return in_array($operacion, ['push', 'commit', 'clone']);
    }
}
```

<Aside type="caution">
‚ö†Ô∏è **Importante**: El ManejadorGit ejecuta comandos del sistema. Aseg√∫rate de validar todas las entradas y usar en entornos confiables. Nunca permitas rutas o URLs arbitrarias de usuarios no confiables.
</Aside>

<Aside type="tip">
üí° **Tip**: Para operaciones complejas, considera usar el patr√≥n Command para encapsular operaciones Git complejas y hacerlas m√°s testeables.
</Aside>
