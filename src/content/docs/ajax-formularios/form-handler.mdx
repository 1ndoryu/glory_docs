---
title: FormHandler
description: Sistema de routing y procesamiento para formularios AJAX en WordPress
sidebar:
  label: FormHandler
  order: 1
---

import { Steps, Tabs, TabItem, Aside } from '@astrojs/starlight/components';

# FormHandler

El **FormHandler** es el n√∫cleo del sistema de formularios AJAX de Glory Framework. Proporciona un sistema de routing inteligente que autom√°ticamente encuentra y ejecuta el manejador apropiado para cada formulario basado en una `subAccion`, permitiendo una arquitectura modular y extensible.

## Filosof√≠a

FormHandler est√° dise√±ado para ser:
- **Modular**: Cada formulario tiene su propio manejador espec√≠fico
- **Extensible**: Permite registrar namespaces adicionales desde la aplicaci√≥n
- **Seguro**: Sanitiza todas las entradas y valida permisos
- **Robusto**: Manejo completo de errores con logging detallado

## Arquitectura

### Componentes del Sistema

1. **FormHandler**: Clase principal que maneja el routing
2. **FormHandlerInterface**: Contrato que deben implementar todos los handlers
3. **Handlers espec√≠ficos**: Clases que procesan formularios particulares
4. **Sistema de namespaces**: Permite extender desde la aplicaci√≥n

### Flujo de Procesamiento

```mermaid
graph TD
    A[Frontend env√≠a formulario] --> B[FormHandler::manejarPeticion]
    B --> C[Extraer subAccion]
    C --> D[Buscar handler en namespaces]
    D --> E{Handler encontrado?}
    E -->|No| F[Error: Handler no existe]
    E -->|S√≠| G[Instanciar handler]
    G --> H[Validar m√©todo procesar()]
    H --> I[Llamar procesar($_POST, $_FILES)]
    I --> J[Retornar respuesta JSON]
```

## Configuraci√≥n Inicial

### Activaci√≥n del Sistema

```php
use Glory\Handler\FormHandler;

// Inicializar el sistema (se hace autom√°ticamente si est√° activado)
$formHandler = new FormHandler();

// O verificar que est√© activo
if (GloryFeatures::isActive('gloryForm', 'glory_componente_glory_form_activado')) {
    // El sistema est√° activo
}
```

### Opciones de Configuraci√≥n

```php
// En functions.php o configuraci√≥n del tema
OpcionManager::register('glory_componente_glory_form_activado', [
    'type' => 'checkbox',
    'label' => 'Activar sistema de formularios AJAX',
    'description' => 'Permite el procesamiento de formularios v√≠a AJAX',
    'default' => true,
    'section' => 'glory_ajax'
]);
```

## Uso B√°sico

### Estructura de un Formulario AJAX

```php
// En tu template PHP
$form = new FormBuilder('mi-formulario');
$form->action('gloryFormHandler')
     ->method('POST')
     ->addHidden('subAccion', 'CrearPublicacion')
     ->addTextarea('postContent', 'Contenido de la publicaci√≥n')
     ->addSelect('postType', ['post' => 'Entrada', 'page' => 'P√°gina'])
     ->render();
```

### JavaScript para Env√≠o

```javascript
// Usando GloryAjax (recomendado)
document.getElementById('mi-formulario').addEventListener('submit', function(e) {
    e.preventDefault();

    const formData = new FormData(this);

    gloryAjax.post('gloryFormHandler', formData)
        .then(function(response) {
            if (response.success) {
                alert(response.data.alert);
                // Recargar p√°gina o actualizar UI
                location.reload();
            } else {
                alert('Error: ' + response.data.alert);
            }
        })
        .catch(function(error) {
            console.error('Error AJAX:', error);
            alert('Error al procesar el formulario');
        });
});
```

### Handler Espec√≠fico

```php
<?php

namespace App\Handlers\Form;

use Glory\Handler\Form\FormHandlerInterface;

class MiFormularioHandler implements FormHandlerInterface
{
    public function procesar(array $postDatos, array $archivos): array
    {
        // 1. Validar y sanitizar datos
        $contenido = sanitize_textarea_field($postDatos['postContent'] ?? '');
        $tipoPost = sanitize_text_field($postDatos['postType'] ?? 'post');

        if (empty($contenido)) {
            throw new \Exception('El contenido no puede estar vac√≠o');
        }

        // 2. Verificar permisos
        if (!current_user_can('publish_posts')) {
            throw new \Exception('No tienes permisos para publicar');
        }

        // 3. Procesar la l√≥gica
        $postId = wp_insert_post([
            'post_title' => 'Nueva publicaci√≥n',
            'post_content' => $contenido,
            'post_type' => $tipoPost,
            'post_status' => 'publish'
        ]);

        if (is_wp_error($postId)) {
            throw new \Exception('Error al crear la publicaci√≥n');
        }

        // 4. Retornar respuesta
        return [
            'alert' => '¬°Publicaci√≥n creada exitosamente!',
            'postId' => $postId,
            'redirect' => get_permalink($postId)
        ];
    }
}
```

## Sistema de Namespaces

### Extensi√≥n desde la Aplicaci√≥n

```php
// En functions.php de tu tema
use Glory\Handler\FormHandler;

// Registrar namespace de tu aplicaci√≥n (prioridad alta)
FormHandler::registerHandlerNamespace('App\\Handlers\\Form\\');

// Ahora el sistema buscar√° primero en App\Handlers\Form\ y luego en Glory\Handler\Form\
```

### Prioridad de B√∫squeda

El sistema busca handlers en el siguiente orden:

1. **Namespaces registrados por la aplicaci√≥n** (en orden de registro)
2. **Namespace por defecto de Glory** (`Glory\Handler\Form\`)

Esto permite sobreescribir handlers de Glory desde la aplicaci√≥n.

## Handlers Incluidos

### CrearPublicacionHandler

Crea publicaciones de cualquier tipo con metadatos y archivos adjuntos.

```php
// Uso en formulario
$form->addHidden('subAccion', 'CrearPublicacion')
     ->addTextarea('postContent', 'Contenido...')
     ->addSelect('postType', ['post', 'page', 'evento'])
     ->addFile('archivo_adjunto');
```

### GuardarMetaHandler

Guarda metadatos en posts existentes.

```php
// Para actualizar metadatos de un post existente
$form->addHidden('subAccion', 'GuardarMeta')
     ->addHidden('postId', $postId)
     ->addText('meta_clave', 'Valor del metadato');
```

## Creaci√≥n de Handlers Personalizados

### Estructura B√°sica

```php
<?php

namespace App\Handlers\Form;

use Glory\Handler\Form\FormHandlerInterface;

class ContactoHandler implements FormHandlerInterface
{
    public function procesar(array $postDatos, array $archivos): array
    {
        try {
            // 1. Validaci√≥n de datos
            $this->validarDatos($postDatos);

            // 2. Procesamiento espec√≠fico
            $resultado = $this->procesarContacto($postDatos);

            // 3. Logging
            GloryLogger::info('Formulario de contacto procesado', [
                'email' => $postDatos['email']
            ]);

            // 4. Respuesta de √©xito
            return [
                'alert' => '¬°Mensaje enviado correctamente!',
                'contactId' => $resultado['id']
            ];

        } catch (\Exception $e) {
            GloryLogger::error('Error en formulario de contacto', [
                'error' => $e->getMessage(),
                'datos' => $postDatos
            ]);

            throw $e; // Re-lanzar para manejo autom√°tico
        }
    }

    private function validarDatos(array $datos): void
    {
        $requeridos = ['nombre', 'email', 'mensaje'];

        foreach ($requeridos as $campo) {
            if (empty($datos[$campo])) {
                throw new \Exception("El campo {$campo} es obligatorio");
            }
        }

        if (!is_email($datos['email'])) {
            throw new \Exception('El email no es v√°lido');
        }
    }

    private function procesarContacto(array $datos): array
    {
        // L√≥gica espec√≠fica (guardar en BD, enviar email, etc.)
        // ...

        return ['id' => uniqid('contact_')];
    }
}
```

### Convenciones de Nomenclatura

- **Nombre del archivo**: `{SubAccion}Handler.php`
- **Nombre de clase**: `{SubAccion}Handler`
- **SubAccion**: PascalCase, sin espacios
- **Namespace**: Debe terminar en `\Form\`

Ejemplos:
- `subAccion: 'CrearUsuario'` ‚Üí `CrearUsuarioHandler`
- `subAccion: 'EnviarEmail'` ‚Üí `EnviarEmailHandler`

## Manejo de Archivos

### Upload de Archivos

```php
public function procesar(array $postDatos, array $archivos): array
{
    // Procesar archivos adjuntos
    if (!empty($archivos)) {
        require_once(ABSPATH . 'wp-admin/includes/file.php');
        require_once(ABSPATH . 'wp-admin/includes/media.php');
        require_once(ABSPATH . 'wp-admin/includes/image.php');

        foreach ($archivos as $campo => $archivo) {
            if ($archivo['error'] !== UPLOAD_ERR_OK) {
                continue;
            }

            // Subir archivo a WordPress
            $attachmentId = media_handle_upload($campo, 0);

            if (is_wp_error($attachmentId)) {
                throw new \Exception("Error al subir {$campo}: " . $attachmentId->get_error_message());
            }

            // Guardar referencia
            update_post_meta($postId, $campo, $attachmentId);
        }
    }

    return ['alert' => 'Archivos procesados correctamente'];
}
```

### Validaci√≥n de Archivos

```php
private function validarArchivo(array $archivo, array $config): void
{
    // Verificar errores de upload
    if ($archivo['error'] !== UPLOAD_ERR_OK) {
        throw new \Exception('Error al subir el archivo');
    }

    // Verificar tama√±o
    $maxSize = $config['max_size'] ?? 5 * 1024 * 1024; // 5MB
    if ($archivo['size'] > $maxSize) {
        throw new \Exception('Archivo demasiado grande');
    }

    // Verificar tipo MIME
    $tiposPermitidos = $config['mime_types'] ?? ['image/jpeg', 'image/png'];
    $tipoMime = mime_content_type($archivo['tmp_name']);

    if (!in_array($tipoMime, $tiposPermitidos)) {
        throw new \Exception('Tipo de archivo no permitido');
    }
}
```

## Seguridad

### Sanitizaci√≥n Autom√°tica

El sistema autom√°ticamente sanitiza:
- **Campos de texto**: `sanitize_text_field()`
- **√Åreas de texto**: `sanitize_textarea_field()`
- **Emails**: Validaci√≥n espec√≠fica
- **N√∫meros**: `intval()`, `floatval()`

### Validaci√≥n de Permisos

```php
public function procesar(array $postDatos, array $archivos): array
{
    // Verificar nonce si se usa
    if (isset($postDatos['nonce'])) {
        if (!wp_verify_nonce($postDatos['nonce'], 'mi_form_nonce')) {
            throw new \Exception('Nonce inv√°lido');
        }
    }

    // Verificar permisos del usuario
    if (!current_user_can('publish_posts')) {
        throw new \Exception('Permisos insuficientes');
    }

    // Verificar ownership si aplica
    $postId = $postDatos['postId'] ?? 0;
    if ($postId && get_post_field('post_author', $postId) != get_current_user_id()) {
        throw new \Exception('No eres el autor de esta publicaci√≥n');
    }

    // Continuar con procesamiento...
}
```

### Protecci√≥n contra XSS

```php
// El sistema previene XSS sanitizando autom√°ticamente
// Pero puedes a√±adir validaci√≥n adicional

private function validarContenido(string $contenido): string
{
    // Sanitizar HTML si se permite
    $contenido = wp_kses($contenido, [
        'strong' => [],
        'em' => [],
        'a' => ['href' => [], 'title' => []],
        'br' => []
    ]);

    // Verificar longitud
    if (strlen($contenido) > 10000) {
        throw new \Exception('Contenido demasiado largo');
    }

    return $contenido;
}
```

## Manejo de Errores

### Errores Comunes

```php
try {
    // Procesamiento del formulario
} catch (\Exception $e) {
    // Logging autom√°tico por FormHandler

    // Tipos de errores comunes:
    switch ($e->getMessage()) {
        case 'No tienes permiso para crear este tipo de publicaci√≥n.':
            // Error de permisos
            break;

        case 'El tipo de publicaci√≥n \'evento\' no es v√°lido.':
            // Tipo de post inv√°lido
            break;

        default:
            // Error gen√©rico
            break;
    }

    throw $e; // Dejar que FormHandler maneje la respuesta JSON
}
```

### Respuestas Personalizadas

```php
public function procesar(array $postDatos, array $archivos): array
{
    // Respuesta b√°sica
    return [
        'alert' => 'Operaci√≥n completada',
        'redirect' => '/gracias',
        'reload' => false,
        'extraData' => ['id' => 123]
    ];

    // Respuesta con m√∫ltiples mensajes
    return [
        'alert' => 'Usuario creado correctamente',
        'messages' => [
            'success' => ['Usuario registrado'],
            'info' => ['Se envi√≥ email de confirmaci√≥n']
        ],
        'userId' => $newUserId
    ];
}
```

## Integraci√≥n con FormBuilder

### Formulario Completo

```php
$form = new FormBuilder('contact-form');
$form->action('gloryFormHandler')
     ->method('POST')
     ->addHidden('subAccion', 'Contacto')
     ->addHidden('nonce', wp_create_nonce('contact_form'))
     ->addText('nombre', 'Nombre completo', ['required' => true])
     ->addEmail('email', 'Correo electr√≥nico', ['required' => true])
     ->addTextarea('mensaje', 'Mensaje', ['required' => true, 'rows' => 5])
     ->addFile('adjunto', 'Archivo adjunto', [
         'accept' => '.pdf,.doc,.docx',
         'max_size' => 2 * 1024 * 1024 // 2MB
     ])
     ->addButton('submit', 'Enviar mensaje', ['type' => 'submit'])
     ->render();
```

### JavaScript Avanzado

```javascript
// Con validaci√≥n del lado cliente
document.getElementById('contact-form').addEventListener('submit', function(e) {
    e.preventDefault();

    // Validaci√≥n b√°sica
    const form = this;
    if (!form.checkValidity()) {
        form.reportValidity();
        return;
    }

    // Mostrar loading
    const submitBtn = form.querySelector('button[type="submit"]');
    const originalText = submitBtn.textContent;
    submitBtn.disabled = true;
    submitBtn.textContent = 'Enviando...';

    // Enviar formulario
    const formData = new FormData(form);

    gloryAjax.post(form.action, formData)
        .then(function(response) {
            if (response.success) {
                alert(response.data.alert);

                // Redireccionar si se especifica
                if (response.data.redirect) {
                    window.location.href = response.data.redirect;
                } else {
                    form.reset();
                }
            } else {
                alert('Error: ' + (response.data.alert || 'Error desconocido'));
            }
        })
        .catch(function(error) {
            console.error('Error:', error);
            alert('Error al enviar el formulario. Int√©ntalo de nuevo.');
        })
        .finally(function() {
            // Restaurar bot√≥n
            submitBtn.disabled = false;
            submitBtn.textContent = originalText;
        });
});
```

## Debugging y Monitoreo

### Logging Autom√°tico

FormHandler registra autom√°ticamente:
- Inicio de procesamiento
- √âxito en operaciones
- Errores con contexto completo
- Datos de $_POST y $_FILES (en modo debug)

### Depuraci√≥n en Desarrollo

```php
// En wp-config.php para desarrollo
define('WP_DEBUG', true);
define('WP_DEBUG_LOG', true);

// Los logs aparecer√°n en wp-content/debug.log
// Busca entradas con "FormHandler" o "formulario"
```

### Verificaci√≥n de Handlers

```php
// Funci√≥n de utilidad para verificar handlers disponibles
function debug_form_handlers() {
    if (!WP_DEBUG) return;

    $namespaces = [
        'App\\Handlers\\Form\\',
        'Glory\\Handler\\Form\\'
    ];

    echo '<h3>Handlers de Formulario Disponibles</h3>';
    echo '<ul>';

    foreach ($namespaces as $ns) {
        $path = str_replace('\\', '/', $ns);
        $files = glob(get_template_directory() . '/src/' . $path . '*Handler.php');

        foreach ($files as $file) {
            $className = basename($file, '.php');
            $subAccion = str_replace('Handler', '', $className);
            echo "<li>{$ns}{$className} ‚Üí subAccion: '{$subAccion}'</li>";
        }
    }

    echo '</ul>';
}
add_action('wp_footer', 'debug_form_handlers');
```

## Casos de Uso Avanzados

### Formulario de Registro Multi-paso

```php
class RegistroUsuarioHandler implements FormHandlerInterface
{
    public function procesar(array $postDatos, array $archivos): array
    {
        $paso = intval($postDatos['paso'] ?? 1);

        switch ($paso) {
            case 1:
                return $this->procesarPaso1($postDatos);
            case 2:
                return $this->procesarPaso2($postDatos);
            case 3:
                return $this->procesarPaso3($postDatos);
            default:
                throw new \Exception('Paso inv√°lido');
        }
    }

    private function procesarPaso1(array $datos): array
    {
        // Validar email √∫nico
        if (email_exists($datos['email'])) {
            throw new \Exception('Este email ya est√° registrado');
        }

        // Guardar datos temporales en sesi√≥n/transient
        $tempId = wp_generate_uuid4();
        set_transient('registro_' . $tempId, $datos, HOUR_IN_SECONDS);

        return [
            'alert' => 'Email verificado correctamente',
            'siguiente_paso' => 2,
            'temp_id' => $tempId
        ];
    }
}
```

### Formulario con Dependencias

```php
class PedidoProductoHandler implements FormHandlerInterface
{
    public function procesar(array $postDatos, array $archivos): array
    {
        $productoId = intval($postDatos['producto_id']);
        $cantidad = intval($postDatos['cantidad']);

        // Verificar stock disponible
        $stock = get_post_meta($productoId, '_stock', true);
        if ($cantidad > $stock) {
            throw new \Exception("Solo hay {$stock} unidades disponibles");
        }

        // Calcular precio total
        $precioUnitario = get_post_meta($productoId, '_price', true);
        $total = $precioUnitario * $cantidad;

        // Crear pedido
        $pedidoId = wp_insert_post([
            'post_type' => 'pedido',
            'post_title' => "Pedido de " . get_current_user()->display_name,
            'post_status' => 'pending'
        ]);

        // Guardar metadatos del pedido
        update_post_meta($pedidoId, 'producto_id', $productoId);
        update_post_meta($pedidoId, 'cantidad', $cantidad);
        update_post_meta($pedidoId, 'total', $total);

        return [
            'alert' => 'Pedido creado correctamente',
            'pedido_id' => $pedidoId,
            'total' => $total,
            'redirect' => home_url('/checkout?pedido=' . $pedidoId)
        ];
    }
}
```

## Mejores Pr√°cticas

### Estructura de Handlers

```php
class MiHandler implements FormHandlerInterface
{
    public function procesar(array $postDatos, array $archivos): array
    {
        // 1. Validaci√≥n temprana
        $this->validarDatosBasicos($postDatos);

        // 2. Autorizaci√≥n
        $this->verificarPermisos($postDatos);

        // 3. Procesamiento principal
        $resultado = $this->ejecutarLogica($postDatos, $archivos);

        // 4. Limpieza
        $this->limpiarDatosTemporales();

        // 5. Respuesta
        return $this->formatearRespuesta($resultado);
    }

    // M√©todos privados para organizaci√≥n
    private function validarDatosBasicos(array $datos): void { /* ... */ }
    private function verificarPermisos(array $datos): void { /* ... */ }
    private function ejecutarLogica(array $datos, array $archivos): array { /* ... */ }
    private function limpiarDatosTemporales(): void { /* ... */ }
    private function formatearRespuesta(array $resultado): array { /* ... */ }
}
```

### Testing de Handlers

```php
// Funci√≥n de testeo para desarrollo
function test_form_handler(string $handlerClass, array $testData): array
{
    if (!WP_DEBUG) return ['error' => 'Solo disponible en modo debug'];

    try {
        $handler = new $handlerClass();
        $resultado = $handler->procesar($testData, []);

        return [
            'success' => true,
            'resultado' => $resultado
        ];
    } catch (\Exception $e) {
        return [
            'success' => false,
            'error' => $e->getMessage()
        ];
    }
}

// Uso en desarrollo
$resultado = test_form_handler('App\\Handlers\\Form\\ContactoHandler', [
    'nombre' => 'Juan P√©rez',
    'email' => 'juan@example.com',
    'mensaje' => 'Mensaje de prueba'
]);
```

<Aside type="caution">
‚ö†Ô∏è **Importante**: Los handlers tienen acceso completo a $_POST y $_FILES. Siempre valida y sanitiza todas las entradas para prevenir vulnerabilidades de seguridad.
</Aside>

<Aside type="tip">
üí° **Tip**: Usa el patr√≥n de namespaces para mantener tus handlers organizados y permitir sobreescribir funcionalidades de Glory seg√∫n las necesidades espec√≠ficas de tu aplicaci√≥n.
</Aside>
