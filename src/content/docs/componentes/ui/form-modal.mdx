---
title: Sistema de Formularios Modales
description: Gestor avanzado de formularios dentro de modales con creaci√≥n/edici√≥n AJAX, upload de im√°genes y validaciones din√°micas
---

import { Card, CardGrid } from '@astrojs/starlight/components';

# Sistema de Formularios Modales (`formModal.js`)

El sistema de formularios modales proporciona una soluci√≥n completa para gestionar formularios dentro de modales con funcionalidades avanzadas como creaci√≥n/edici√≥n AJAX, upload de im√°genes con `wp.media`, selects dependientes, validaciones din√°micas y gesti√≥n de estado compleja.

## üöÄ Inicio R√°pido

```html
<!-- Trigger para abrir modal en modo creaci√≥n -->
<button type="button"
        class="abrir-modal"
        data-modal-target="mi-modal"
        data-form-mode="create"
        data-submit-action="guardar_usuario"
        data-modal-title="Crear Usuario">
    Crear Usuario
</button>

<!-- Trigger para abrir modal en modo edici√≥n -->
<button type="button"
        class="abrir-modal"
        data-modal-target="mi-modal"
        data-form-mode="edit"
        data-fetch-action="cargar_usuario"
        data-object-id="123"
        data-modal-title-edit="Editar Usuario">
    Editar
</button>

<!-- Modal con formulario -->
<div id="mi-modal" class="glory-modal">
    <div class="modal-content">
        <h2>T√≠tulo del Modal</h2>
        <form class="gloryForm">
            <!-- Campos del formulario -->
            <input type="text" name="nombre" required>
            <input type="email" name="email" required>

            <!-- Bot√≥n de env√≠o -->
            <button type="submit" class="dataSubir" data-accion="guardar_usuario">
                Guardar
            </button>
        </form>
    </div>
</div>
```

```javascript
// El sistema se inicializa autom√°ticamente
// No requiere configuraci√≥n adicional
```

## üìã Funcionalidades

### Gesti√≥n de Estados del Modal

#### Modo Creaci√≥n (`data-form-mode="create"`)
- Limpia autom√°ticamente todos los campos del formulario
- Resetea uploads de im√°genes a estado inicial
- Elimina cualquier dato residual de ediciones previas
- Prepara el formulario para nuevos datos

#### Modo Edici√≥n (`data-form-mode="edit"`)
- Carga datos v√≠a AJAX usando `data-fetch-action`
- Rellena autom√°ticamente todos los campos del formulario
- Gestiona im√°genes existentes y previews
- Mantiene estado consistente entre cargas

### Sistema de Upload de Im√°genes
Integraci√≥n completa con `wp.media` para gesti√≥n de im√°genes:

```html
<!-- Uploader b√°sico de im√°genes -->
<div class="glory-image-uploader">
    <input type="hidden" name="imagen_id" class="glory-image-id">
    <div class="image-preview" data-placeholder="Haz clic para subir una imagen">
        <span class="image-preview-placeholder">Haz clic para subir una imagen</span>
    </div>
    <button type="button" class="glory-upload-image-button">Seleccionar Imagen</button>
    <button type="button" class="glory-remove-image-button oculto">Eliminar</button>
</div>
```

### Selects Dependientes
Sistema declarativo para cargar opciones din√°micamente:

```html
<!-- Select dependiente de otro campo -->
<select name="pais" data-fm-depende="" data-fm-accion-opciones="cargar_paises">
    <option value="">Seleccione pa√≠s</option>
</select>

<select name="ciudad"
        data-fm-depende="pais"
        data-fm-accion-opciones="cargar_ciudades"
        data-fm-placeholder-deshabilitado="Seleccione un pa√≠s primero">
    <option value="">Seleccione ciudad</option>
</select>
```

### Validaci√≥n Din√°mica de Submit
Habilita/deshabilita el bot√≥n de env√≠o basado en campos requeridos:

```html
<form class="gloryForm" data-fm-submit-habilitar-cuando="email,telefono">
    <input type="email" name="email">
    <input type="tel" name="telefono">
    <button type="submit" class="dataSubir" disabled>Enviar</button>
</form>
```

### Gesti√≥n de Servicios/Grupos
Sistema especial para checkboxes con opci√≥n "Seleccionar todos":

```html
<div class="services-field">
    <label><input type="checkbox" name="services[]" value="all"> Todos los servicios</label>
    <label><input type="checkbox" name="services[]" value="1"> Servicio 1</label>
    <label><input type="checkbox" name="services[]" value="2"> Servicio 2</label>
    <label><input type="checkbox" name="services[]" value="3"> Servicio 3</label>
</div>
```

## üé® Caracter√≠sticas Visuales

### Estados del Formulario
- **Creaci√≥n**: Campos limpios, placeholders activos, botones de eliminaci√≥n ocultos
- **Edici√≥n**: Campos poblados, im√°genes cargadas, previews visibles
- **Validaci√≥n**: Bot√≥n submit habilitado/deshabilidado din√°micamente

### Gesti√≥n de Im√°genes
- **Preview interactivo**: Click en preview abre selector de im√°genes
- **Estados visuales**: Placeholder cuando vac√≠o, imagen cuando cargada
- **Bot√≥n eliminar**: Visible solo cuando hay imagen seleccionada
- **Sincronizaci√≥n**: ID y URL mantenidos en campos ocultos

### Estructura HTML Generada

```html
<!-- Modal con formulario t√≠pico -->
<div class="glory-modal">
    <div class="modal-content">
        <h2>T√≠tulo Din√°mico</h2>
        <form class="gloryForm" data-object-id="123">
            <!-- Campos del formulario -->

            <!-- Uploader de imagen -->
            <div class="glory-image-uploader">
                <input type="hidden" name="imagen_id" class="glory-image-id" value="456">
                <div class="image-preview">
                    <img src="url-de-la-imagen.jpg" alt="Preview">
                    <button class="previewRemover">√ó</button>
                </div>
                <button class="glory-upload-image-button">Cambiar</button>
                <button class="glory-remove-image-button">Eliminar</button>
            </div>

            <button type="submit" class="dataSubir" data-accion="actualizar">
                Actualizar
            </button>
        </form>
    </div>
</div>
```

## üîß Configuraci√≥n Avanzada

### Atributos de Datos para Triggers

#### Atributos Comunes
- `data-modal-target`: ID del modal a abrir
- `data-modal-title`: T√≠tulo base del modal
- `data-modal-title-create`: T√≠tulo espec√≠fico para modo creaci√≥n
- `data-modal-title-edit`: T√≠tulo espec√≠fico para modo edici√≥n

#### Modo Creaci√≥n
- `data-form-mode="create"`: Activa modo creaci√≥n
- `data-submit-action`: Action AJAX para guardar
- `data-submit-text`: Texto del bot√≥n submit

#### Modo Edici√≥n
- `data-form-mode="edit"`: Activa modo edici√≥n
- `data-fetch-action`: Action AJAX para cargar datos
- `data-object-id`: ID del objeto a editar

### Configuraci√≥n de Selects Dependientes

#### Atributos para Selects
- `data-fm-accion-opciones`: Action AJAX para cargar opciones
- `data-fm-depende`: Campos de los que depende (separados por coma)
- `data-fm-placeholder-deshabilitado`: Placeholder cuando dependencias faltan
- `data-fm-selected-value`: Valor preseleccionado tras carga
- `data-fm-keep-current`: Mantiene valor actual visible aunque no est√© en opciones
- `data-fm-exclude-param`: Par√°metro para excluir opci√≥n actual en edici√≥n

### Configuraci√≥n de Validaci√≥n
- `data-fm-submit-habilitar-cuando`: Campos requeridos (separados por coma)

### Variables Globales de Debug
```javascript
// Habilitar logs detallados
window.gloryDebug = true;

// Ver estado de inicializaci√≥n
console.log('FormModal inicializado:', window.gloryFormModalInitialized);
```

## üìù API T√©cnica

### Funciones Principales

#### `gloryFormModal()`
Funci√≥n principal que inicializa el sistema de formularios modales.

```javascript
// Se ejecuta autom√°ticamente en DOMContentLoaded y gloryRecarga
gloryFormModal();
```

### Eventos Personalizados

#### `gloryModal:open`
Se dispara cuando se abre un modal con formulario.

```javascript
document.addEventListener('gloryModal:open', function(event) {
    const { modal, trigger } = event.detail;
    console.log('Modal abierto:', modal.id);
});
```

#### `gloryFormModal:beforeCreate`
Antes de preparar el formulario para creaci√≥n.

```javascript
document.addEventListener('gloryFormModal:beforeCreate', function(event) {
    // Preparar datos espec√≠ficos antes de limpiar
});
```

#### `gloryFormModal:afterCreate`
Despu√©s de preparar el formulario para creaci√≥n.

```javascript
document.addEventListener('gloryFormModal:afterCreate', function(event) {
    // Configuraciones adicionales post-creaci√≥n
});
```

#### `gloryFormModal:beforeEdit`
Antes de cargar datos para edici√≥n.

```javascript
document.addEventListener('gloryFormModal:beforeEdit', function(event) {
    const { objectId } = event.detail;
    console.log('Cargando objeto:', objectId);
});
```

#### `gloryFormModal:afterEdit`
Despu√©s de cargar datos para edici√≥n.

```javascript
document.addEventListener('gloryFormModal:afterEdit', function(event) {
    const { objectId, data } = event.detail;
    console.log('Datos cargados para:', objectId, data);
});
```

#### `gloryFormModal:optionsLoaded`
Cuando se cargan opciones para un select dependiente.

```javascript
document.addEventListener('gloryFormModal:optionsLoaded', function(event) {
    const { select, options, payload } = event.detail;
    console.log('Opciones cargadas para', select.name, ':', options.length);
});
```

### Sistema AJAX Interno
Utiliza `gloryAjax` o fallback a `fetch` para WordPress:

```javascript
// Funci√≥n interna para llamadas AJAX
async function callAjax(action, payload) {
    if (typeof window.gloryAjax === 'function') {
        return await window.gloryAjax(action, payload);
    }
    // Fallback manual
}
```

## üéØ Casos de Uso

### Formulario de Usuario Completo
```html
<!-- Trigger -->
<button class="abrir-modal"
        data-modal-target="usuario-modal"
        data-form-mode="create"
        data-submit-action="guardar_usuario"
        data-modal-title-create="Crear Usuario">
    Nuevo Usuario
</button>

<!-- Modal -->
<div id="usuario-modal" class="glory-modal">
    <div class="modal-content">
        <h2>Crear Usuario</h2>
        <form class="gloryForm" data-fm-submit-habilitar-cuando="email,nombre">
            <div class="campo">
                <label>Nombre:</label>
                <input type="text" name="nombre" required>
            </div>

            <div class="campo">
                <label>Email:</label>
                <input type="email" name="email" required>
            </div>

            <div class="campo">
                <label>Pa√≠s:</label>
                <select name="pais" data-fm-accion-opciones="cargar_paises">
                    <option value="">Seleccione pa√≠s</option>
                </select>
            </div>

            <div class="campo">
                <label>Ciudad:</label>
                <select name="ciudad"
                        data-fm-depende="pais"
                        data-fm-accion-opciones="cargar_ciudades"
                        data-fm-placeholder-deshabilitado="Seleccione un pa√≠s primero">
                    <option value="">Seleccione ciudad</option>
                </select>
            </div>

            <div class="campo">
                <label>Avatar:</label>
                <div class="glory-image-uploader">
                    <input type="hidden" name="avatar_id" class="glory-image-id">
                    <div class="image-preview" data-placeholder="Haz clic para subir avatar">
                        <span class="image-preview-placeholder">Haz clic para subir avatar</span>
                    </div>
                    <button type="button" class="glory-upload-image-button">Seleccionar Avatar</button>
                    <button type="button" class="glory-remove-image-button oculto">Eliminar</button>
                </div>
            </div>

            <div class="campo">
                <label>Servicios:</label>
                <div class="services-field">
                    <label><input type="checkbox" name="services[]" value="all"> Todos los servicios</label>
                    <label><input type="checkbox" name="services[]" value="1"> Servicio 1</label>
                    <label><input type="checkbox" name="services[]" value="2"> Servicio 2</label>
                </div>
            </div>

            <button type="submit" class="dataSubir" data-accion="guardar_usuario">
                Crear Usuario
            </button>
        </form>
    </div>
</div>
```

### Gesti√≥n de Productos con Dependencias
```html
<form class="gloryForm">
    <select name="categoria" data-fm-accion-opciones="cargar_categorias">
        <option value="">Seleccione categor√≠a</option>
    </select>

    <select name="subcategoria"
            data-fm-depende="categoria"
            data-fm-accion-opciones="cargar_subcategorias"
            data-fm-placeholder-deshabilitado="Seleccione una categor√≠a primero">
        <option value="">Seleccione subcategor√≠a</option>
    </select>

    <select name="producto"
            data-fm-depende="categoria,subcategoria"
            data-fm-accion-opciones="cargar_productos">
        <option value="">Seleccione producto</option>
    </select>
</form>
```

### Formulario de Configuraci√≥n
```html
<form class="gloryForm" data-fm-submit-habilitar-cuando="titulo">
    <input type="text" name="titulo" placeholder="T√≠tulo requerido" required>

    <div class="glory-image-uploader">
        <input type="hidden" name="logo_id" class="glory-image-id">
        <div class="image-preview" data-placeholder="Logo de la empresa">
            <span class="image-preview-placeholder">Logo de la empresa</span>
        </div>
        <button type="button" class="glory-upload-image-button">Seleccionar Logo</button>
        <button type="button" class="glory-remove-image-button oculto">Eliminar Logo</button>
    </div>

    <button type="submit" class="dataSubir" disabled>Guardar Configuraci√≥n</button>
</form>
```

## üîÑ Compatibilidad

- ‚úÖ **WordPress**: Integraci√≥n completa con `wp.media` para uploads
- ‚úÖ **AJAX**: Compatible con `gloryAjax` y fallback manual
- ‚úÖ **Modales**: Funciona con cualquier sistema de modales que emita `gloryModal:open`
- ‚úÖ **Responsive**: Se adapta a diferentes tama√±os de pantalla
- ‚úÖ **Accesibilidad**: Soporte b√°sico para navegaci√≥n por teclado
- ‚úÖ **Validaci√≥n**: Validaci√≥n HTML5 nativa + validaci√≥n din√°mica
- ‚úÖ **Estados**: Gesti√≥n robusta de estados creaci√≥n/edici√≥n
- ‚úÖ **Dependencias**: Sistema de selects dependientes multi-nivel

## üêõ Soluci√≥n de Problemas

### Problemas Comunes

1. **Modal no se abre**: Verificar `data-modal-target` coincide con ID del modal
2. **Datos no se cargan en edici√≥n**: Revisar `data-fetch-action` y `data-object-id`
3. **Selects dependientes no cargan**: Verificar `data-fm-depende` y `data-fm-accion-opciones`
4. **Im√°genes no se suben**: Confirmar que `wp.media` est√° disponible
5. **Bot√≥n submit permanece deshabilitado**: Revisar `data-fm-submit-habilitar-cuando`

### Debug Avanzado
```javascript
// Habilitar debug completo
window.gloryDebug = true;

// Monitorear eventos del formulario
document.addEventListener('gloryFormModal:afterEdit', function(e) {
    console.log('Datos cargados:', e.detail.data);
});

document.addEventListener('gloryFormModal:optionsLoaded', function(e) {
    console.log('Opciones cargadas para', e.detail.select.name, ':', e.detail.options);
});

// Verificar estado del formulario
const form = document.querySelector('.gloryForm');
console.log('Object ID:', form.dataset.objectId);
console.log('Campos con valor:', Array.from(form.elements).filter(el => el.value));
```

### Verificaci√≥n de Integraci√≥n
```javascript
// Verificar que todos los componentes est√©n disponibles
console.log('gloryAjax disponible:', typeof window.gloryAjax);
console.log('wp.media disponible:', typeof wp !== 'undefined' && wp.media);
console.log('Modal system disponible:', typeof window.gloryModal !== 'undefined');

// Verificar inicializaci√≥n
console.log('FormModal inicializado:', window.gloryFormModalInitialized);
```

### Troubleshooting de Im√°genes
```javascript
// Verificar configuraci√≥n de uploader
const uploader = document.querySelector('.glory-image-uploader');
if (uploader) {
    const imageId = uploader.querySelector('.glory-image-id');
    const preview = uploader.querySelector('.image-preview');
    const uploadBtn = uploader.querySelector('.glory-upload-image-button');

    console.log('Uploader config:', {
        hasImageId: !!imageId,
        hasPreview: !!preview,
        hasUploadBtn: !!uploadBtn,
        previewPlaceholder: preview?.dataset.placeholder
    });
}
```

### Reset Manual
```javascript
// Forzar reinicializaci√≥n (solo para debug)
window.gloryFormModalInitialized = false;
gloryFormModal();

// Limpiar formulario manualmente
const form = document.querySelector('.gloryForm');
if (form) {
    form.reset();
    form.removeAttribute('data-object-id');

    // Limpiar uploaders
    form.querySelectorAll('.glory-image-uploader').forEach(uploader => {
        const imageId = uploader.querySelector('.glory-image-id');
        const preview = uploader.querySelector('.image-preview');
        if (imageId) imageId.value = '';
        if (preview) {
            preview.innerHTML = '<span class="image-preview-placeholder">' +
                (preview.dataset.placeholder || 'Haz clic para subir una imagen') + '</span>';
        }
    });
}
```












