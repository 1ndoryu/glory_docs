---
title: Sistema de Navegaci√≥n AJAX
description: Navegaci√≥n as√≠ncrona con prefetching inteligente, cache avanzado y gesti√≥n de assets
---

import { Card, CardGrid } from '@astrojs/starlight/components';

# Sistema de Navegaci√≥n AJAX (`gloryAjaxNav.js`)

Sistema avanzado de navegaci√≥n AJAX que proporciona transiciones de p√°gina fluidas, prefetching inteligente, cache avanzado y gesti√≥n autom√°tica de assets, manteniendo el framework completamente agn√≥stico.

## üöÄ Inicio R√°pido

```html
<!-- Estructura HTML requerida -->
<div id="content">
    <!-- Contenido principal de la p√°gina -->
</div>

<div id="loadingBar" style="position: fixed; top: 0; left: 0; height: 3px; background: #007cba; width: 0%; z-index: 9999;"></div>
```

```javascript
// Configuraci√≥n opcional (antes de cargar el script)
window.gloryNavConfig = {
    contentSelector: '#content',
    prefetchOnHover: true,
    cacheEnabled: true
};
```

```html
<!-- El script se inicializa autom√°ticamente -->
<script src="Glory/assets/js/genericAjax/gloryAjaxNav.js"></script>
```

## üìã Funcionalidades

### Navegaci√≥n AJAX Inteligente
- **Detecci√≥n autom√°tica**: Convierte enlaces internos en navegaci√≥n AJAX
- **Fallback completo**: Navegaci√≥n normal si AJAX falla
- **Manejo de errores**: Timeout y recuperaci√≥n autom√°tica
- **Historia del navegador**: Soporte completo para back/forward

### Sistema de Cache Avanzado
- **Cache inteligente**: Basado en URL y par√°metros de consulta
- **Persistencia de sesi√≥n**: Cache v√°lido durante la sesi√≥n del navegador
- **Reutilizaci√≥n de nodos**: Evita re-renderizado innecesario
- **Scripts del head**: Cache de scripts cr√≠ticos de configuraci√≥n

### Prefetching Inteligente
- **Hover prefetching**: Carga anticipada al pasar el mouse
- **Viewport prefetching**: Carga cuando los enlaces entran en vista
- **Control de concurrencia**: L√≠mite de peticiones simult√°neas
- **Deduplicaci√≥n**: Evita prefetch duplicado

### Gesti√≥n de Assets
- **Carga autom√°tica**: Scripts y estilos externos de p√°ginas nuevas
- **Ejecuci√≥n secuencial**: Mantiene dependencias y orden
- **Detecci√≥n de duplicados**: Evita cargar assets ya presentes
- **Scripts cr√≠ticos**: Extracci√≥n y ejecuci√≥n de configuraci√≥n

## üîß Configuraci√≥n

### Configuraci√≥n por Defecto
```javascript
const defaults = {
    enabled: true,                    // Habilitar/deshabilitar AJAX
    contentSelector: '#content',      // Selector del contenido principal
    mainScrollSelector: '#main',      // Elemento para hacer scroll al top
    loadingBarSelector: '#loadingBar', // Barra de progreso
    cacheEnabled: true,              // Habilitar cache
    prefetchOnHover: true,           // Prefetch en hover/mousedown
    prefetchDelayMs: 50,             // Retraso para prefetch
    prefetchInViewport: false,       // Prefetch por visibilidad
    prefetchMaxEntries: 24,          // L√≠mite de entradas prefetch
    requestTimeoutMs: 10000,         // Timeout para requests
    optimizeImages: true,            // Lazy loading en im√°genes
    allowAsyncExternalScripts: true, // Permitir carga async de scripts
    ignoreUrlPatterns: [...],        // Patrones de URL a ignorar
    ignoreUrlParams: ['s', 'nocache'], // Par√°metros que evitan cache
    noAjaxClass: 'noAjax',           // Clase para deshabilitar AJAX
    criticalScriptKeywords: [],      // Keywords para scripts cr√≠ticos
    syncHeadSeo: false,              // Sincronizar meta tags SEO
    headSeoConfig: {...},            // Config SEO
    skipInlineScriptTypes: [...],    // Tipos de scripts a saltar
    skipInlineScriptSelectors: [],   // Selectores de scripts a saltar
    shouldSkipAjax: null,            // Hook personalizado para skip
    shouldAbortInit: null            // Hook para abortar inicializaci√≥n
};
```

### Configuraci√≥n Personalizada
```javascript
// Configuraci√≥n global
window.gloryNavConfig = {
    contentSelector: '.main-content',
    loadingBarSelector: '.progress-bar',
    prefetchOnHover: false,
    prefetchInViewport: true,
    criticalScriptKeywords: ['appConfig', 'siteVars'],
    ignoreUrlPatterns: [
        '/wp-admin',
        '/api/',
        '\\.(pdf|jpg|png)$'
    ]
};

// O configuraci√≥n local
window.dataGlobal = { /* misma estructura */ };
```

## üé® Funcionalidades Detalladas

### Detecci√≥n de URLs a Procesar

#### URLs que se procesan con AJAX
```javascript
// ‚úÖ Se procesan autom√°ticamente:
// - Enlaces internos del mismo dominio
// - URLs relativas
// - P√°ginas HTML v√°lidas
```

#### URLs que se ignoran
```javascript
// ‚ùå Navegaci√≥n normal del navegador:
// - Enlaces externos (diferente dominio)
// - target="_blank"
// - download attribute
// - Modifiers keys (Ctrl, Shift, Alt)
// - Patrones configurados (wp-admin, archivos, etc.)
```

### Sistema de Cache

#### Cache Autom√°tico
```javascript
// El cache se activa autom√°ticamente para URLs v√°lidas
// Se guarda: contenido HTML, scripts del head, nodos DOM
const pageCache = {
    'https://example.com/page': {
        content: '<div>Contenido...</div>',
        headScripts: ['script cr√≠tico...'],
        nodeChildren: [/* nodos DOM */]
    }
};
```

#### Par√°metros que Evitan Cache
```javascript
// URLs con estos par√°metros no se cachean:
ignoreUrlParams: ['s', 'nocache', 'preview', 'debug']
// Ejemplo: /page?s=searchterm (no se cachea)
```

### Prefetching Avanzado

#### Hover Prefetching
```javascript
// Se activa en eventos:
// - mouseover
// - mousedown
// - focusin
// Con retraso configurable (50ms por defecto)
```

#### Viewport Prefetching
```javascript
// Usa IntersectionObserver para detectar enlaces visibles
// Margen de 200px para prefetch anticipado
// L√≠mite m√°ximo configurable (24 enlaces por defecto)
```

### Gesti√≥n de Scripts

#### Scripts Inline
```javascript
// Se ejecutan autom√°ticamente del contenido nuevo
// Se salta JSON-LD y tipos configurados
executeInlineScriptsFromElement(contentElement);
```

#### Scripts Externos
```javascript
// Carga secuencial por defecto
// Soporte para async si est√° marcado
// Detecci√≥n de duplicados autom√°tica
```

#### Scripts Cr√≠ticos del Head
```javascript
// Extracci√≥n basada en keywords
criticalScriptKeywords: ['appConfig', 'fusionAppConfig']

// Se ejecutan antes de otros assets
// Se cachean para reutilizaci√≥n
```

## üîÑ Eventos y Estados

### Evento `gloryRecarga`
```javascript
// Se dispara despu√©s de cada carga AJAX
// Permite reinicializar componentes din√°micos
document.addEventListener('gloryRecarga', () => {
    // Reinicializar galer√≠as, formularios, etc.
    initGalleries();
    initForms();
});
```

### Estados de Carga
```javascript
// Estados visuales durante la carga:
// 1. Opacidad del contenido: 0.5
// 2. Barra de progreso: 0% ‚Üí 70% ‚Üí 100%
// 3. Fade out de la barra despu√©s de completar
```

### Manejo del Historial
```javascript
// PushState para nuevas p√°ginas
history.pushState({url: newUrl}, '', newUrl);

// PopState para navegaci√≥n back/forward
window.addEventListener('popstate', handlePopState);
```

## üéØ Caracter√≠sticas Avanzadas

### Optimizaci√≥n de Im√°genes
```javascript
// Autom√°ticamente a√±ade loading="lazy" a im√°genes
if (config.optimizeImages) {
    contentElement.querySelectorAll('img:not([loading])')
        .forEach(img => img.setAttribute('loading', 'lazy'));
}
```

### Sincronizaci√≥n SEO
```javascript
// Opcional: sincroniza meta tags del head
syncHeadSeo: true,
headSeoConfig: {
    canonicalSelector: 'link[rel="canonical"]',
    metaSelectors: ['meta[name="description"]'],
    jsonLdSelectors: ['script[type="application/ld+json"]']
}
```

### Anclas Internas
```javascript
// Manejo especial para enlaces con hash
// Scroll suave a elementos internos
// Actualizaci√≥n de URL sin nueva entrada de historial
```

### Manejo de Errores
```javascript
// Fallback autom√°tico a navegaci√≥n normal en:
// - Errores de red
// - Timeout
// - Contenido no HTML
// - Selectores no encontrados
```

## üîß Configuraci√≥n Avanzada

### Hooks Personalizados
```javascript
// Hook para decidir si saltar AJAX
shouldSkipAjax: function(url, linkElement) {
    // L√≥gica personalizada
    return url.includes('/admin/');
}

// Hook para abortar inicializaci√≥n
shouldAbortInit: function() {
    // Condiciones de abort
    return window.isMobile && !config.enableMobileAjax;
}
```

### Selectores Personalizados
```javascript
// Para temas con estructura diferente
contentSelector: '.main-content-area',
mainScrollSelector: '.scroll-container',
loadingBarSelector: '.ajax-progress'
```

### Configuraci√≥n de Assets
```javascript
// Control de carga de scripts externos
allowAsyncExternalScripts: true, // Permitir async marcado
// Scripts con data-glory-async o async="" se cargan en paralelo
```

## üêõ Soluci√≥n de Problemas

### Problemas Comunes

1. **AJAX no se activa**: Verificar selectores y configuraci√≥n
2. **Cache no funciona**: Revisar par√°metros de URL ignorados
3. **Assets no cargan**: Verificar dependencias y orden
4. **Scripts no ejecutan**: Revisar tipos saltados y keywords cr√≠ticos

### Debug
```javascript
// Habilitar logging detallado
window.gloryDebug = true;

// Verificar inicializaci√≥n
console.log('AJAX Nav initialized:', window.gloryAjaxNavInitialized);

// Verificar cache
console.log('Cache entries:', Object.keys(pageCache).length);

// Verificar configuraci√≥n
console.log('Current config:', config);
```

### Verificaci√≥n de Selectores
```javascript
// Verificar elementos requeridos existen
const content = document.querySelector('#content');
const loadingBar = document.querySelector('#loadingBar');

if (!content) {
    console.error('Content selector not found');
}
```

## üìä Performance

- **Cache inteligente**: Reduce requests repetidas
- **Prefetching**: Carga anticipada reduce latencia percibida
- **Lazy loading**: Im√°genes se cargan seg√∫n necesidad
- **Debouncing**: Eventos de scroll/throttle optimizados
- **Memory management**: Limpieza autom√°tica de referencias

## üîÑ Compatibilidad

- ‚úÖ **Modern Browsers**: Fetch API, History API, IntersectionObserver
- ‚úÖ **Legacy**: Fallback a navegaci√≥n normal
- ‚úÖ **Mobile**: Touch events y responsive
- ‚úÖ **WordPress**: Integraci√≥n completa con themes
- ‚úÖ **Frameworks**: Agn√≥stico, funciona con cualquier estructura
- ‚úÖ **SEO**: Preserva meta tags y estructura

## üéØ Casos de Uso

### Tema WordPress Est√°ndar
```php
// functions.php - configuraci√≥n
wp_enqueue_script('glory-ajax-nav', get_template_directory_uri() . '/Glory/assets/js/genericAjax/gloryAjaxNav.js', [], '1.0', true);

wp_localize_script('glory-ajax-nav', 'gloryNavConfig', array(
    'contentSelector' => '#content',
    'prefetchOnHover' => true,
    'criticalScriptKeywords' => array('appConfig', 'themeConfig')
));
```

### SPA-like con WordPress
```javascript
// Configuraci√≥n avanzada
window.gloryNavConfig = {
    contentSelector: '.main-content',
    prefetchInViewport: true,
    syncHeadSeo: true,
    headSeoConfig: {
        canonicalSelector: 'link[rel="canonical"]',
        metaSelectors: ['meta[name="description"]', 'meta[property="og:title"]']
    },
    shouldSkipAjax: function(url) {
        return url.includes('/wp-admin/') || url.includes('/wp-login.php');
    }
};
```

### Optimizaci√≥n para E-commerce
```javascript
// Configuraci√≥n para tienda online
window.gloryNavConfig = {
    prefetchMaxEntries: 50, // M√°s prefetch para navegaci√≥n de producto
    ignoreUrlParams: ['utm_source', 'utm_medium', 'session_id'],
    criticalScriptKeywords: ['cartConfig', 'productData'],
    optimizeImages: true,
    allowAsyncExternalScripts: true
};
```











