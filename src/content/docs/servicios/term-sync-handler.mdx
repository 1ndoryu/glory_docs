---
title: TermSyncHandler
description: Manejador de sincronizaci√≥n de t√©rminos de taxonom√≠a con gesti√≥n autom√°tica de categor√≠as
---

import { Card, CardGrid } from '@astrojs/starlight/components';

## Descripci√≥n General

El `TermSyncHandler` gestiona la sincronizaci√≥n autom√°tica de t√©rminos de taxonom√≠a, especialmente categor√≠as, durante los procesos de sincronizaci√≥n de contenido por defecto. Mantiene la consistencia entre las definiciones de t√©rminos y los t√©rminos existentes en WordPress.

## Funcionalidades Principales

### üìÇ Gesti√≥n de Categor√≠as
- **Sincronizaci√≥n autom√°tica**: Crea y actualiza categor√≠as desde definiciones
- **Eliminaci√≥n de obsoletos**: Remueve t√©rminos que ya no est√°n en las definiciones
- **Preservaci√≥n de datos**: Mantiene relaciones existentes cuando es posible

### üè∑Ô∏è Control de T√©rminos
- **Creaci√≥n condicional**: Solo crea t√©rminos inexistentes
- **Actualizaci√≥n de metadatos**: Gestiona campos adicionales como descripciones
- **Im√°genes de categor√≠a**: Asocia im√°genes a t√©rminos usando AssetsUtility

### üîÑ Ciclo de Vida
- **Sincronizaci√≥n completa**: Ejecuta creaci√≥n, actualizaci√≥n y limpieza en secuencia
- **Transaccional**: Maneja errores sin dejar estados inconsistentes
- **Logging detallado**: Registra todas las operaciones realizadas

## Uso B√°sico

### Sincronizaci√≥n Completa

```php
use Glory\Services\Sync\TermSyncHandler;

$handler = new TermSyncHandler();

// Sincronizar todas las definiciones de t√©rminos
$handler->sync();
```

## Definici√≥n de T√©rminos

### Estructura Global

```php
// En functions.php o archivo de configuraci√≥n
$GLOBALS['glory_categorias_definidas'] = [
    [
        'nombre' => 'Noticias',
        'descripcion' => 'Art√≠culos y novedades de la empresa',
        'imagenAsset' => 'glory::news-category.jpg'
    ],
    [
        'nombre' => 'Productos',
        'descripcion' => 'Informaci√≥n sobre nuestros productos',
        'imagenAsset' => 'colors::products-bg.jpg'
    ],
    [
        'nombre' => 'Servicios',
        'descripcion' => 'Servicios que ofrecemos',
        // Sin imagen espec√≠fica
    ]
];
```

## Proceso de Sincronizaci√≥n

### Flujo de Trabajo

```php
public function sync(): void
{
    $categoriasDef = $GLOBALS['glory_categorias_definidas'] ?? [];

    if (empty($categoriasDef)) {
        return; // No hay definiciones para sincronizar
    }

    // 1. Eliminar t√©rminos obsoletos
    $this->deleteObsoleteTerms($categoriasDef);

    // 2. Crear/actualizar t√©rminos definidos
    $this->createOrUpdateTerms($categoriasDef);
}
```

## Gesti√≥n de T√©rminos Obsoletos

### Identificaci√≥n y Eliminaci√≥n

```php
private function deleteObsoleteTerms(array $definitions): void
{
    // Obtener nombres de t√©rminos definidos
    $definedNames = array_filter(array_column($definitions, 'nombre'));

    // Buscar t√©rminos gestionados autom√°ticamente
    $managedTerms = get_terms([
        'taxonomy' => 'category',
        'hide_empty' => false,
        'meta_key' => self::META_CLAVE_CATEGORIA_GESTIONADA,
        'meta_value' => '1'
    ]);

    if (is_wp_error($managedTerms)) {
        return; // Error consultando t√©rminos
    }

    // Eliminar t√©rminos no definidos
    foreach ($managedTerms as $term) {
        if (!in_array($term->name, $definedNames, true)) {
            wp_delete_term($term->term_id, 'category');
            // Logging opcional aqu√≠
        }
    }
}
```

### Marcado de T√©rminos Gestionados

```php
// Constante para identificar t√©rminos gestionados
const META_CLAVE_CATEGORIA_GESTIONADA = '_glory_managed_category';

// Al crear/actualizar t√©rminos
update_term_meta($term->term_id, self::META_CLAVE_CATEGORIA_GESTIONADA, '1');
```

## Creaci√≥n y Actualizaci√≥n de T√©rminos

### Proceso de Gesti√≥n Individual

```php
private function createOrUpdateTerms(array $definitions): void
{
    foreach ($definitions as $def) {
        $nombre = $def['nombre'] ?? null;

        if (!$nombre) {
            continue; // Saltar definiciones sin nombre
        }

        // Buscar t√©rmino existente
        $term = get_term_by('name', $nombre, 'category');

        if (!$term) {
            // Crear nuevo t√©rmino
            $result = wp_insert_term($nombre, 'category', [
                'description' => $def['descripcion'] ?? ''
            ]);

            if (!is_wp_error($result)) {
                $term = get_term($result['term_id']);
            }
        }

        // Si el t√©rmino existe, actualizarlo
        if ($term instanceof \WP_Term) {
            $this->updateTermData($term, $def);
        }
    }
}
```

### Actualizaci√≥n de Datos

```php
private function updateTermData(\WP_Term $term, array $definition): void
{
    // Marcar como gestionado
    update_term_meta($term->term_id, self::META_CLAVE_CATEGORIA_GESTIONADA, '1');

    // Actualizar descripci√≥n si es diferente
    if ($term->description !== ($definition['descripcion'] ?? '')) {
        wp_update_term($term->term_id, 'category', [
            'description' => $definition['descripcion'] ?? ''
        ]);
    }

    // Gestionar imagen asociada
    $this->updateTermImage($term, $definition);
}
```

## Gesti√≥n de Im√°genes de Categor√≠a

### Asociaci√≥n de Im√°genes

```php
private function updateTermImage(\WP_Term $term, array $definition): void
{
    $imageAsset = $definition['imagenAsset'] ?? null;

    if (!$imageAsset) {
        return; // No hay imagen definida
    }

    // Verificar si ya tiene imagen asignada
    $existingImageId = get_term_meta($term->term_id, 'glory_category_image_id', true);

    if ($existingImageId) {
        return; // Ya tiene imagen, no sobrescribir
    }

    // Obtener ID del adjunto desde asset
    $attachmentId = AssetsUtility::get_attachment_id_from_asset($imageAsset);

    if ($attachmentId) {
        update_term_meta($term->term_id, 'glory_category_image_id', $attachmentId);
    }
}
```

## API de M√©todos

### `sync(): void`
Sincroniza todas las definiciones de t√©rminos globales.

## Consideraciones de Seguridad

### Taxonom√≠a Limitada

Actualmente solo gestiona la taxonom√≠a `category` (categor√≠as por defecto de WordPress). Para otras taxonom√≠as personalizadas, se requerir√≠a extensi√≥n del c√≥digo.

### Preservaci√≥n de Datos

- **No elimina t√©rminos con posts**: Los t√©rminos que tienen posts asociados no se eliminan autom√°ticamente
- **No sobrescribe im√°genes**: Si un t√©rmino ya tiene imagen asignada, no se reemplaza
- **Mantiene slugs**: Los slugs de t√©rminos existentes se preservan

## Logging y Monitoreo

### Operaciones Registradas

```php
// Logging se puede activar descomentando l√≠neas en el c√≥digo:
/*
GloryLogger::info("TermSyncHandler: Categor√≠a '{$term->name}' eliminada.");
GloryLogger::info("TermSyncHandler: Categor√≠a '{$nombre}' creada.");
GloryLogger::info("TermSyncHandler: Categor√≠a '{$term->name}' actualizada.");
*/
```

### Monitoreo de Estado

```php
function obtenerEstadoSincronizacionTerminos(): array {
    $definidos = count($GLOBALS['glory_categorias_definidas'] ?? []);
    $existentes = count(get_terms(['taxonomy' => 'category', 'hide_empty' => false]));
    $gestionados = count(get_terms([
        'taxonomy' => 'category',
        'hide_empty' => false,
        'meta_key' => '_glory_managed_category',
        'meta_value' => '1'
    ]));

    return [
        'definidos' => $definidos,
        'existentes' => $existentes,
        'gestionados' => $gestionados,
        'sincronizados' => ($definidos === $gestionados)
    ];
}
```

## Ejemplos Pr√°cticos

### Definici√≥n B√°sica de Categor√≠as

```php
// En functions.php
function definirCategoriasEmpresa() {
    $GLOBALS['glory_categorias_definidas'] = [
        [
            'nombre' => 'Empresa',
            'descripcion' => 'Informaci√≥n institucional y corporativa',
            'imagenAsset' => 'glory::empresa-category.jpg'
        ],
        [
            'nombre' => 'Productos',
            'descripcion' => 'Cat√°logo de productos y servicios',
            'imagenAsset' => 'colors::blue-category.jpg'
        ],
        [
            'nombre' => 'Blog',
            'descripcion' => 'Art√≠culos, noticias y actualidad',
            'imagenAsset' => 'elements::blog-icon.jpg'
        ],
        [
            'nombre' => 'Soporte',
            'descripcion' => 'Preguntas frecuentes y soporte t√©cnico',
            // Sin imagen espec√≠fica
        ]
    ];
}
add_action('init', 'definirCategoriasEmpresa');
```

### Sincronizaci√≥n Programada

```php
// Sincronizaci√≥n autom√°tica al activar tema
function sincronizarTerminosAlActivar() {
    $handler = new TermSyncHandler();
    $handler->sync();
}
add_action('after_switch_theme', 'sincronizarTerminosAlActivar');

// Sincronizaci√≥n manual v√≠a AJAX
function ajax_sync_terms() {
    if (!current_user_can('manage_categories')) {
        wp_die('No autorizado');
    }

    $handler = new TermSyncHandler();
    $handler->sync();

    wp_send_json_success(['message' => 'T√©rminos sincronizados']);
}
add_action('wp_ajax_sync_glory_terms', 'ajax_sync_terms');
```

### Verificaci√≥n de Sincronizaci√≥n

```php
function verificarSincronizacionTerminos(): array {
    $definiciones = $GLOBALS['glory_categorias_definidas'] ?? [];
    $problemas = [];

    foreach ($definiciones as $def) {
        $term = get_term_by('name', $def['nombre'], 'category');

        if (!$term) {
            $problemas[] = "T√©rmino '{$def['nombre']}' no existe";
            continue;
        }

        // Verificar descripci√≥n
        if ($term->description !== ($def['descripcion'] ?? '')) {
            $problemas[] = "Descripci√≥n de '{$def['nombre']}' no coincide";
        }

        // Verificar imagen
        if (!empty($def['imagenAsset'])) {
            $imageId = get_term_meta($term->term_id, 'glory_category_image_id', true);
            if (!$imageId) {
                $problemas[] = "Imagen faltante para '{$def['nombre']}'";
            }
        }
    }

    return $problemas;
}
```

## Extensi√≥n para Otras Taxonom√≠as

### Soporte para Taxonom√≠as Personalizadas

```php
// Versi√≥n extendida para m√∫ltiples taxonom√≠as
class ExtendedTermSyncHandler extends TermSyncHandler
{
    private array $supportedTaxonomies = ['category', 'product_cat', 'custom_tax'];

    public function syncAllTaxonomies(): void
    {
        foreach ($this->supportedTaxonomies as $taxonomy) {
            $this->syncTaxonomy($taxonomy);
        }
    }

    private function syncTaxonomy(string $taxonomy): void
    {
        $definitions = $this->getDefinitionsForTaxonomy($taxonomy);

        if (empty($definitions)) {
            return;
        }

        $this->deleteObsoleteTermsForTaxonomy($taxonomy, $definitions);
        $this->createOrUpdateTermsForTaxonomy($taxonomy, $definitions);
    }
}
```

## Casos de Uso Avanzados

### Sincronizaci√≥n Condicional

```php
// Solo sincronizar si han cambiado las definiciones
function sincronizacionCondicionalTerminos(): bool {
    $currentHash = md5(serialize($GLOBALS['glory_categorias_definidas'] ?? []));
    $storedHash = get_option('glory_terms_definition_hash');

    if ($currentHash !== $storedHash) {
        update_option('glory_terms_definition_hash', $currentHash);
        return true;
    }

    return false;
}
```

### Backup de T√©rminos

```php
function crearBackupTerminos(): void {
    $terms = get_terms([
        'taxonomy' => 'category',
        'hide_empty' => false
    ]);

    $backup = [];
    foreach ($terms as $term) {
        $backup[] = [
            'term_id' => $term->term_id,
            'name' => $term->name,
            'slug' => $term->slug,
            'description' => $term->description,
            'image_id' => get_term_meta($term->term_id, 'glory_category_image_id', true),
            'managed' => get_term_meta($term->term_id, '_glory_managed_category', true),
            'backup_date' => current_time('mysql')
        ];
    }

    update_option('glory_terms_backup', $backup);
}
```

### Restauraci√≥n desde Backup

```php
function restaurarTerminosDesdeBackup(): void {
    $backup = get_option('glory_terms_backup');

    if (!$backup) {
        return;
    }

    foreach ($backup as $termData) {
        $term = get_term_by('name', $termData['name'], 'category');

        if (!$term) {
            // Recrear t√©rmino
            $result = wp_insert_term($termData['name'], 'category', [
                'description' => $termData['description']
            ]);

            if (!is_wp_error($result)) {
                $termId = $result['term_id'];

                // Restaurar metadatos
                if ($termData['image_id']) {
                    update_term_meta($termId, 'glory_category_image_id', $termData['image_id']);
                }

                if ($termData['managed']) {
                    update_term_meta($termId, '_glory_managed_category', $termData['managed']);
                }
            }
        }
    }
}
```

## Integraci√≥n con el Sistema

### Con DefaultContentSynchronizer

```php
class DefaultContentSynchronizer
{
    private TermSyncHandler $termHandler;

    public function __construct() {
        $this->termHandler = new TermSyncHandler();
    }

    public function sincronizar(): void {
        // 1. Sincronizar t√©rminos primero
        $this->termHandler->sync();

        // 2. Luego sincronizar posts (que pueden depender de t√©rminos)
        $this->sincronizarPosts();
    }
}
```

### Hooks de WordPress

```php
// Sincronizaci√≥n autom√°tica en eventos importantes
add_action('init', function() {
    // Verificar si es necesario sincronizar (una vez por d√≠a)
    $lastSync = get_option('glory_terms_last_sync');
    $needsSync = !$lastSync || (time() - $lastSync) > DAY_IN_SECONDS;

    if ($needsSync) {
        $handler = new TermSyncHandler();
        $handler->sync();
        update_option('glory_terms_last_sync', time());
    }
});

// Sincronizaci√≥n manual v√≠a admin
add_action('admin_post_sync_glory_terms', function() {
    if (!current_user_can('manage_categories')) {
        wp_die('No tienes permisos');
    }

    $handler = new TermSyncHandler();
    $handler->sync();

    wp_redirect(admin_url('admin.php?page=glory-settings&sync=success'));
    exit;
});
```

## Troubleshooting

### T√©rminos No Se Crean

```php
// Verificar definiciones
$definitions = $GLOBALS['glory_categorias_definidas'] ?? [];
if (empty($definitions)) {
    error_log('No hay definiciones de t√©rminos');
    return;
}

// Verificar nombres √∫nicos
$names = array_column($definitions, 'nombre');
if (count($names) !== count(array_unique($names))) {
    error_log('Nombres de t√©rminos duplicados');
}
```

### Im√°genes No Se Asocian

```php
// Verificar que AssetsUtility est√© disponible
if (!class_exists('Glory\\Utility\\AssetsUtility')) {
    error_log('AssetsUtility no disponible');
    return;
}

// Verificar que el asset existe
$asset = 'glory::category-image.jpg';
if (!AssetsUtility::assetExists($asset)) {
    error_log("Asset no existe: {$asset}");
}
```

### T√©rminos No Se Eliminan

```php
// Verificar que no tienen posts asociados
$term = get_term_by('name', 'Categoria Antigua', 'category');
if ($term) {
    $postsCount = $term->count;
    if ($postsCount > 0) {
        error_log("No se puede eliminar t√©rmino '{$term->name}': tiene {$postsCount} posts");
    }
}
```

## Testing

### Tests B√°sicos

```php
class TermSyncHandlerTest extends \PHPUnit\Framework\TestCase
{
    public function testSyncCreatesTerms()
    {
        // Configurar definiciones de prueba
        $GLOBALS['glory_categorias_definidas'] = [
            ['nombre' => 'Test Category', 'descripcion' => 'Descripci√≥n de prueba']
        ];

        $handler = new TermSyncHandler();
        $handler->sync();

        // Verificar que se cre√≥
        $term = get_term_by('name', 'Test Category', 'category');
        $this->assertInstanceOf(\WP_Term::class, $term);
        $this->assertEquals('Descripci√≥n de prueba', $term->description);
    }

    public function testSyncDeletesObsoleteTerms()
    {
        // Crear t√©rmino manualmente
        wp_insert_term('Term To Delete', 'category');

        // Definir solo otro t√©rmino
        $GLOBALS['glory_categorias_definidas'] = [
            ['nombre' => 'Keep This Term']
        ];

        $handler = new TermSyncHandler();
        $handler->sync();

        // Verificar que se elimin√≥ el t√©rmino obsoleto
        $deletedTerm = get_term_by('name', 'Term To Delete', 'category');
        $this->assertFalse($deletedTerm);
    }
}
```

### Tests de Integraci√≥n

```php
public function testFullIntegration()
{
    // Configurar entorno de prueba
    $this->setupTestDefinitions();

    // Ejecutar sincronizaci√≥n
    $handler = new TermSyncHandler();
    $handler->sync();

    // Verificar estado final
    $this->assertTermExists('Category 1');
    $this->assertTermExists('Category 2');
    $this->assertTermHasDescription('Category 1', 'Description 1');
    $this->assertTermHasImage('Category 1');
}
```

## Rendimiento y Optimizaci√≥n

### Consultas Eficientes

```php
// Usar get_terms con filtros apropiados
$terms = get_terms([
    'taxonomy' => 'category',
    'hide_empty' => false,
    'fields' => 'ids', // Solo IDs para mejor rendimiento
    'meta_key' => self::META_CLAVE_CATEGORIA_GESTIONADA,
    'meta_value' => '1'
]);
```

### Procesamiento por Lotes

```php
// Para muchas definiciones, procesar en lotes
function syncTermsInBatches(array $definitions, int $batchSize = 10): void {
    $batches = array_chunk($definitions, $batchSize);

    foreach ($batches as $batch) {
        foreach ($batch as $definition) {
            // Procesar cada definici√≥n
        }

        // Peque√±a pausa entre lotes
        usleep(100000); // 100ms
    }
}
```

### Cach√© de Resultados

```php
// Cache de t√©rminos para evitar consultas repetidas
private static $termsCache = [];

private function getTermCached(string $name, string $taxonomy): ?\WP_Term {
    $key = $taxonomy . '_' . $name;

    if (!isset(self::$termsCache[$key])) {
        self::$termsCache[$key] = get_term_by('name', $name, $taxonomy);
    }

    return self::$termsCache[$key];
}
```
