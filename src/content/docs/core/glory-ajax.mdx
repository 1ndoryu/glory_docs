---
title: GloryAjax
description: Utilidad JavaScript centralizada para peticiones AJAX en Glory Framework.
sidebar:
  order: 2
---

`gloryAjax` es una función envoltorio (wrapper) sobre `fetch` diseñada para estandarizar la comunicación asíncrona entre el frontend y WordPress. Gestiona automáticamente la creación de `FormData`, cabeceras, nonces y el parseo de respuestas JSON o binarias (archivos).

## Cuándo usarlo

- Para cualquier petición AJAX personalizada hacia `admin-ajax.php`.
- Cuando necesitas enviar formularios complejos (incluyendo archivos) sin configurar manualmente `multipart/form-data`.
- Para descargar archivos generados dinámicamente (PDF, CSV, imágenes) desde el servidor.
- Para asegurar compatibilidad con el modo de edición de constructores visuales (detecta y evita ejecuciones en `fb-edit`).

## API Básica

La función está disponible globalmente como `gloryAjax` (y su alias `enviarAjax`).

```javascript
/**
 * @param {string} action - El nombre de la acción de WordPress (wp_ajax_{action}).
 * @param {object|FormData} data - Datos a enviar.
 * @returns {Promise<object>} - Promesa que resuelve con la respuesta normalizada.
 */
const respuesta = await gloryAjax('mi_accion_php', { 
    parametro1: 'valor',
    id: 123 
});
```

### Respuesta Normalizada
`gloryAjax` siempre devuelve un objeto con esta estructura base:

```javascript
{
    success: boolean, // true si HTTP 200 y JSON válido (o descarga exitosa)
    data: any,        // Datos devueltos por el servidor (si es JSON)
    message: string,  // Mensaje de error (si success es false)
    blob: Blob,       // Objeto Blob (solo si es descarga de archivo)
    filename: string  // Nombre del archivo (solo si es descarga de archivo)
}
```

## Funcionamiento Interno

1. **Resolución de URL**: Usa `ajax_params.ajax_url` si está definido (localizado por `AssetManager`), de lo contrario recurre a `/wp-admin/admin-ajax.php`.
2. **Detección de Datos**:
   - Si `data` es una instancia de `FormData`, se envía tal cual (permitiendo subida de archivos).
   - Si es un objeto plano, se convierte a `URLSearchParams` (`application/x-www-form-urlencoded`).
3. **Manejo de Archivos**: Detecta automáticamente cabeceras `Content-Disposition: attachment` o tipos MIME binarios y procesa la respuesta como descarga (`blob`).
4. **Seguridad**: Intercepta y cancela la petición si detecta que se está ejecutando dentro del editor de Fusion Builder (`fb-edit=1`) para evitar conflictos de guardado.

## Ejemplo Mínimo

### JavaScript (Frontend)
```javascript
async function cargarDatosUsuario(userId) {
    const respuesta = await gloryAjax('obtener_usuario', { id: userId });

    if (respuesta.success) {
        console.log('Usuario:', respuesta.data);
    } else {
        console.error('Error:', respuesta.message);
    }
}
```

### PHP (Backend)
```php
// En un Handler o functions.php
add_action('wp_ajax_obtener_usuario', function() {
    // 1. Verificar seguridad (recomendado)
    // check_ajax_referer('mi_nonce', 'nonce'); 

    $id = intval($_POST['id'] ?? 0);
    
    if ($id <= 0) {
        wp_send_json_error(['message' => 'ID inválido']);
    }

    $datos = ['nombre' => 'Juan', 'rol' => 'Editor'];
    
    wp_send_json_success($datos); // Esto llena 'data' en la respuesta JS
});
```

## Ejemplo con Archivos (FormData)

`gloryAjax` simplifica la subida de archivos al detectar `FormData`.

```javascript
const form = document.querySelector('#mi-formulario');
const formData = new FormData(form);

// gloryAjax añadirá automáticamente 'action' al FormData
const respuesta = await gloryAjax('procesar_formulario', formData);
```

## Integración con AssetManager

Para que `gloryAjax` funcione correctamente, asegúrate de que el script `glory-ajax` esté cargado. El framework lo registra automáticamente en el núcleo (`Glory/Config/scriptSetup.php`).

Si necesitas pasar datos adicionales (como un nonce) a tu script que usa `gloryAjax`:

```php
use Glory\Manager\AssetManager;

AssetManager::define('script', 'mi-app', '/ruta/a/mi-app.js', [
    'deps' => ['glory-ajax'], // Declarar dependencia
    'localize' => [
        'nombreObjeto' => 'miAppParams',
        'datos' => [
            'nonce' => wp_create_nonce('mi_seguridad')
        ]
    ]
]);
```

Y en tu JS:
```javascript
await gloryAjax('mi_accion', { 
    nonce: miAppParams.nonce,
    ...otrosDatos 
});
```

## Errores Frecuentes

- **Olvidar el `await`**: `gloryAjax` es asíncrono. Si no usas `await` o `.then()`, no obtendrás la respuesta.
- **Respuesta no JSON**: Si tu handler PHP hace `echo "Hola";` en lugar de `wp_send_json_success()`, `gloryAjax` intentará parsearlo y fallará (o lo devolverá como texto si falla el parseo JSON, dependiendo de la versión, pero lo ideal es siempre JSON).
- **Conflictos de URL**: Si `ajax_params` no está definido globalmente, asumirá la ruta por defecto. Asegúrate de que el framework esté inicializado correctamente.

> **Nota:** Existen funciones auxiliares en el código fuente como `gloryRefresh` o `reiniciarContenido`, pero dependen de handlers específicos (`obtenerHtmlPost`) que deben ser implementados por el tema o módulos adicionales. Para uso general, apégate a `gloryAjax`.
