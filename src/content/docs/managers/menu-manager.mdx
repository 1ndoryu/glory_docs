---
title: MenuManager
description: Gestión automática de menús de navegación con sincronización entre código y WordPress
---

## Resumen

Gestiona menús de navegación de WordPress con sincronización automática entre definiciones de código y menús en la base de datos. En modo desarrollo, permite definir menús programáticamente desde `App/Content/menu.php` y los sincroniza automáticamente. En producción, preserva personalizaciones manuales y gestiona placeholders por defecto.

## Cuándo usarlo

- Cuando necesites definir menús desde código durante desarrollo.
- Cuando quieras sincronizar automáticamente cambios de menú entre código y WordPress.
- Cuando requieras múltiples ubicaciones de menú gestionadas programáticamente.
- Cuando necesites preservar personalizaciones manuales en producción mientras mantienes sincronización en desarrollo.
- No lo uses si solo necesitas menús estáticos sin sincronización: usa `register_nav_menu()` y gestiona los menús manualmente desde WordPress.

## API básica

```php
// register()
MenuManager::register();  // Registra hooks de WordPress y gestiona sincronización automática

// restablecerMenusDesdeCodigo()
MenuManager::restablecerMenusDesdeCodigo();  // Restaura todos los menús a su definición de código (ignora personalizaciones)
```

Nota: `MenuManager` se registra automáticamente cuando la feature `menu` está activa (requiere `GloryFeatures::isActive('menu', 'glory_componente_menu_activado') === true`). No necesitas llamar a `register()` manualmente si usas `Setup` de Glory.

## Definición de menús desde código

### Archivo de definición: `App/Content/menu.php`

El archivo debe retornar un array con la estructura de menús. Puede ser un array numérico (menú único) o asociativo (múltiples ubicaciones).

**Formato de array numérico (menú único):**

```php
<?php
// App/Content/menu.php
return [
    [
        'title' => 'Inicio',
        'url' => '/',
        'children' => []  // opcional, array vacío si no hay hijos
    ],
    [
        'title' => 'Productos',
        'url' => '/productos',
        'children' => [
            [
                'title' => 'Categoría 1',
                'url' => '/productos/categoria-1',
                'children' => []  // soporta jerarquía ilimitada
            ],
            [
                'title' => 'Categoría 2',
                'url' => '/productos/categoria-2'
            ]
        ]
    ],
    [
        'title' => 'Contacto',
        'url' => '/contacto'
    ]
];
```

**Formato de array asociativo (múltiples ubicaciones):**

```php
<?php
// App/Content/menu.php
return [
    'main_navigation' => [
        [
            'title' => 'Inicio',
            'url' => '/'
        ],
        [
            'title' => 'Productos',
            'url' => '/productos',
            'children' => [
                ['title' => 'Categoría 1', 'url' => '/productos/categoria-1']
            ]
        ]
    ],
    'footer_navigation' => [
        ['title' => 'Política de privacidad', 'url' => '/privacidad'],
        ['title' => 'Términos', 'url' => '/terminos']
    ]
];
```

Parámetros de cada ítem:
- **title** (string, requerido): texto visible del menú.
- **url** (string, requerido): URL del enlace. Puede ser relativa (`/ruta`), absoluta (`https://...`), o `#` para ancla vacía.
- **children** (array, opcional): array de ítems hijos con la misma estructura. Soporta jerarquía ilimitada.

Resolución de URLs:
- URLs que empiezan con `/` se convierten a absolutas usando `home_url()`.
- URLs absolutas (`https://...`) se mantienen como están.
- `#` o cadena vacía se mantienen como `#`.

## Ejemplo mínimo

```php
<?php
// App/Content/menu.php
return [
    [
        'title' => 'Inicio',
        'url' => '/'
    ],
    [
        'title' => 'Productos',
        'url' => '/productos',
        'children' => [
            ['title' => 'Categoría 1', 'url' => '/productos/categoria-1'],
            ['title' => 'Categoría 2', 'url' => '/productos/categoria-2']
        ]
    ],
    [
        'title' => 'Contacto',
        'url' => '/contacto'
    ]
];
```

## Ejemplo avanzado

```php
<?php
// App/Content/menu.php - Múltiples ubicaciones con derivación automática
return [
    'main_navigation' => [
        [
            'title' => 'Inicio',
            'url' => home_url('/')
        ],
        [
            'title' => 'Productos',
            'url' => '/productos',
            'children' => [
                ['title' => 'Electrónicos', 'url' => '/productos/electronicos'],
                ['title' => 'Ropa', 'url' => '/productos/ropa']
            ]
        ],
        [
            'title' => 'Marcas',
            'url' => '#',
            'children' => [
                ['title' => 'Marca A', 'url' => '/marcas/marca-a'],
                ['title' => 'Marca B', 'url' => '/marcas/marca-b']
            ]
        ]
    ],
    'footer_navigation' => [
        ['title' => 'Política', 'url' => '/privacidad'],
        ['title' => 'Términos', 'url' => '/terminos']
    ]
    // brands_navigation y products_navigation se derivan automáticamente del principal
];
```

Notas del ejemplo:
- Si defines `main_navigation` con ítems que tienen `title` "Marcas" o "Productos", los menús `brands_navigation` y `products_navigation` se derivan automáticamente extrayendo los `children` de esos ítems.
- Puedes definir explícitamente `brands_navigation` o `products_navigation` para sobrescribir la derivación automática.

## Recomendaciones de uso

- Define los menús del tema en `App/Content/menu.php` durante desarrollo.
- Usa URLs relativas (que empiezan con `/`) para portabilidad entre entornos.
- Mantén jerarquías lógicas y no demasiado profundas (máximo 3-4 niveles recomendado).
- Usa títulos descriptivos y claros para mejor UX.
- En producción, permite que los usuarios personalicen los menús desde WordPress admin; los cambios se preservan automáticamente.

## Notas y límites

- El archivo `App/Content/menu.php` solo se carga en modo desarrollo (`LOCAL = true`). En producción, se ignoran las definiciones de código si el menú fue personalizado manualmente.
- La ubicación `main_navigation` siempre se registra automáticamente. Otras ubicaciones solo se registran en modo desarrollo si están definidas en `menu.php`.
- Si el archivo `menu.php` no existe o retorna un valor inválido, se usa el sistema de placeholders por defecto.
- Los cambios manuales en WordPress admin marcan el menú como desincronizado (`glory_menu_desync = 1`). En producción, los menús desincronizados no se sobrescriben automáticamente.
- El sistema usa transients con clave `glory_menu_lock_{menuId}` para evitar operaciones concurrentes (duración: 15 segundos).

## Modo Dev/Local

- Activación: `App/Config/environment.php` lee `.env` (`LOCAL`). `LOCAL=true` activa el modo desarrollo.
- Efectos en desarrollo (`LOCAL = true`):
  - Se carga `App/Content/menu.php` y se sincronizan todos los menús definidos.
  - Se registran dinámicamente ubicaciones adicionales definidas en código.
  - Los cambios en `menu.php` se aplican automáticamente en cada carga (comparando hashes).
  - Se ignoran estados de desincronización: los cambios de código tienen prioridad sobre personalizaciones manuales.
  - Los menús `brands_navigation` y `products_navigation` se derivan automáticamente del principal si no están definidos explícitamente.
- Efectos en producción (`LOCAL = false` o no definido):
  - No se carga `App/Content/menu.php` para sincronización automática.
  - Solo se gestiona la ubicación `main_navigation` con placeholders por defecto.
  - Los menús personalizados manualmente se preservan (no se sobrescriben).
  - Si un menú tiene `glory_menu_desync = 1` o `glory_customized = 1`, no se modifica automáticamente.

## Integración con el tema

- Define los menús en `App/Content/menu.php` durante desarrollo.
- El `MenuManager` se registra automáticamente cuando la feature `menu` está activa (normalmente en `Setup`).
- Para renderizar menús en plantillas, usa `wp_nav_menu()` con `theme_location`:

```php
// En header.php o plantilla del tema
wp_nav_menu([
    'theme_location' => 'main_navigation',
    'container' => 'nav',
    'container_class' => 'main-navigation',
    'menu_class' => 'nav-menu',
    'fallback_cb' => false
]);
```

## Sistema de placeholders (producción sin definición de código)

Cuando no hay definición de código y el menú no ha sido personalizado, `MenuManager` crea placeholders por defecto:

```php
[
    ['title' => 'Inicio', 'url' => home_url('/')],
    ['title' => 'example', 'url' => '#'],
    ['title' => 'example', 'url' => '#'],
    ['title' => 'example', 'url' => '#'],
    ['title' => 'example', 'url' => '#']
]
```

Comportamiento:
- Los placeholders se normalizan automáticamente: se asegura la cantidad correcta de cada uno.
- Se preservan cuando el usuario edita el menú (si no agrega ítems personalizados).
- Se ordenan según la definición del seed.
- Si el usuario agrega ítems personalizados, el menú se marca como `glory_customized = 1` y los placeholders se preservan junto con los personalizados.

## Estados de sincronización (metadata)

El sistema usa metadata en términos de menú para rastrear estados:

- **`glory_seeded`**: indica que el menú fue inicializado con placeholders por defecto.
- **`glory_customized`**: indica que el usuario agregó ítems personalizados (no placeholders).
- **`glory_menu_desync`**: indica que el menú está desincronizado del código (cambios manuales).
- **`glory_code_hash`**: hash SHA1 de la definición de código actual (para detectar cambios).
- **`glory_seeded_from_code`**: indica que el menú fue creado desde código (no placeholders).

## Diferencias: menús del tema vs menús de Glory

- Tema (`/App`):
  - Se definen en `App/Content/menu.php` con estructura de arrays.
  - Son específicos del proyecto/tema.
  - Se sincronizan automáticamente en modo desarrollo.
- Glory (`/Glory`):
  - El `MenuManager` es agnóstico y gestiona cualquier definición válida.
  - No define menús específicos; solo proporciona la infraestructura de sincronización.

## Errores frecuentes (rápido)

- Definir menús en código sin `LOCAL = true` (no se sincronizan en producción).
- Usar estructura incorrecta en `menu.php` (debe retornar array, no otros tipos).
- Esperar que cambios manuales se preserven en modo desarrollo (en dev, el código tiene prioridad).
- Olvidar activar la feature `menu` (el `MenuManager` no se registra).
- Usar URLs absolutas hardcodeadas (preferir relativas con `/` para portabilidad).
- Definir ubicaciones que no existen en `menu.php` sin estar en modo desarrollo (no se registran).
